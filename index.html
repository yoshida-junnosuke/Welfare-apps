<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PECS Board Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .pecs-card {
            transition: all 0.15s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            position: relative;
            touch-action: manipulation;
        }
        .pecs-card:active { transform: scale(0.96); }
        
        .pin-badge {
            position: absolute; top: 6px; left: 6px;
            color: #F59E0B; font-size: 16px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            z-index: 10;
        }

        /* ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ */
        .cat-require { border: 3px solid #F59E0B; background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%); }
        .cat-life { border: 2px solid #10B981; background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); }
        .cat-food { border: 2px solid #EF4444; background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%); }
        .cat-play { border: 2px solid #3B82F6; background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); }
        .cat-feeling { border: 2px solid #8B5CF6; background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%); }
        .cat-other { border: 2px solid #6B7280; background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%); }

        .playing-highlight {
            border-color: #EF4444 !important;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4);
            transform: scale(1.05);
            z-index: 20;
        }
        
        .toast {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95); color: white;
            padding: 12px 24px; border-radius: 999px;
            font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
            z-index: 9999; pointer-events: none;
        }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º - ã‚ˆã‚Šæ˜ç¢ºãªå·®åˆ† */
        .grid-x-small .card-grid { grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .grid-small .card-grid { grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .grid-medium .card-grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .grid-large .card-grid { grid-template-columns: repeat(3, 1fr); gap: 14px; }
        .grid-x-large .card-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
        
        @media (max-width: 640px) {
            .grid-x-small .card-grid { grid-template-columns: repeat(5, 1fr); }
            .grid-small .card-grid { grid-template-columns: repeat(4, 1fr); }
            .grid-medium .card-grid { grid-template-columns: repeat(3, 1fr); }
            .grid-large .card-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-x-large .card-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-gray-50">

    <header class="bg-white shadow-sm z-10 flex-none border-b">
        <div class="p-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <button onclick="toggleSettings()" class="text-gray-600 hover:text-blue-600 p-1">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-lg font-bold text-gray-700">PECS Pro</h1>
                <span id="modeBadge" class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-bold">æ¼¢å­—</span>
            </div>
            <div class="flex gap-2">
                <button onclick="togglePinFilter()" id="pinFilterBtn" class="text-gray-400 hover:text-yellow-500 p-2 rounded-lg transition-colors">
                    <i class="fas fa-star text-lg"></i>
                </button>
                <button onclick="openCardModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">ä½œã‚‹</span>
                </button>
            </div>
        </div>
        <div class="px-3 pb-2 flex gap-2 overflow-x-auto hide-scrollbar" id="categoryBar"></div>
    </header>

    <main class="flex-1 overflow-y-auto p-3" style="padding-bottom: 220px;" id="mainContainer">
        <div id="cardGrid" class="card-grid grid"></div>
        <div id="emptyState" class="hidden flex-col items-center justify-center mt-20 text-gray-400">
            <i class="fas fa-box-open text-6xl mb-4"></i>
            <p class="font-bold">ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-blue-200 shadow-xl z-20">
        <div id="sentenceStrip" class="flex items-center p-2 gap-2 bg-gradient-to-r from-yellow-50 to-orange-50 overflow-x-auto hide-scrollbar min-h-[110px] relative">
            <div id="stripPlaceholder" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 font-bold">
                <i class="fas fa-hand-pointer mr-2"></i> ã‚«ãƒ¼ãƒ‰ã‚’ãªã‚‰ã¹ã¦ã­
            </div>
        </div>
        <div class="grid grid-cols-5 gap-2 p-2 bg-gray-50">
            <button onclick="popLast()" class="bg-white border-2 border-gray-300 text-gray-600 rounded-lg py-2 flex flex-col items-center active:bg-gray-100 transition-colors">
                <i class="fas fa-backspace text-lg"></i>
                <span class="text-[10px] font-bold mt-1">1ã¤æ¶ˆã™</span>
            </button>
            <button onclick="clearAll()" class="bg-red-50 border-2 border-red-200 text-red-600 rounded-lg py-2 flex flex-col items-center active:bg-red-100 transition-colors">
                <i class="fas fa-trash-alt text-lg"></i>
                <span class="text-[10px] font-bold mt-1">å…¨æ¶ˆã—</span>
            </button>
            <button onclick="playSentence()" id="playBtn" class="col-span-3 bg-blue-600 text-white rounded-lg py-2 shadow-md flex items-center justify-center gap-2 active:bg-blue-700 active:scale-95 transition-all">
                <i class="fas fa-volume-up text-2xl"></i>
                <span class="text-lg font-bold">ãŠã¯ãªã—</span>
            </button>
        </div>
    </footer>

    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div id="settingsPanel" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center" onclick="if(event.target===this) toggleSettings()">
        <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl overflow-hidden shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-4 text-white flex justify-between items-center">
                <span class="font-bold text-lg"><i class="fas fa-cog mr-2"></i>è¨­å®š</span>
                <button onclick="toggleSettings()" class="w-8 h-8 hover:bg-white/20 rounded-full flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
                <div>
                    <label class="text-xs font-bold text-gray-600 mb-2 block">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="modeChildBtn" onclick="setMode('child')" class="py-2 rounded-lg text-sm font-bold border-2 transition-all">
                            <i class="fas fa-child mr-1"></i>ã²ã‚‰ãŒãª
                        </button>
                        <button id="modeAdultBtn" onclick="setMode('adult')" class="py-2 rounded-lg text-sm font-bold border-2 transition-all">
                            <i class="fas fa-user mr-1"></i>æ¼¢å­—
                        </button>
                    </div>
                </div>

                <!-- ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º -->
                <div>
                    <label class="text-xs font-bold text-gray-600 mb-2 block">ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º</label>
                    <div class="flex gap-2">
                        <button onclick="setGridSize('x-small')" id="sizeXS" class="flex-1 py-2 rounded text-xs font-bold border transition-all">æ¥µå°</button>
                        <button onclick="setGridSize('small')" id="sizeS" class="flex-1 py-2 rounded text-xs font-bold border transition-all">å°</button>
                        <button onclick="setGridSize('medium')" id="sizeM" class="flex-1 py-2 rounded text-xs font-bold border transition-all">ä¸­</button>
                        <button onclick="setGridSize('large')" id="sizeL" class="flex-1 py-2 rounded text-xs font-bold border transition-all">å¤§</button>
                        <button onclick="setGridSize('x-large')" id="sizeXL" class="flex-1 py-2 rounded text-xs font-bold border transition-all">ç‰¹å¤§</button>
                    </div>
                </div>

                <!-- ä¸¦ã³é † -->
                <div>
                    <label class="text-xs font-bold text-gray-600 mb-2 block">ä¸¦ã³é †</label>
                    <select id="sortSelect" onchange="setSort(this.value)" class="w-full p-2 border rounded bg-white text-sm">
                        <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ”ãƒ³å„ªå…ˆâ†’æ–°ã—ã„é †ï¼‰</option>
                        <option value="aiueo">äº”åéŸ³é †</option>
                        <option value="category">ã‚«ãƒ†ã‚´ãƒªé †</option>
                        <option value="frequency">ä½¿ç”¨é »åº¦é †</option>
                    </select>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                <div class="pt-2 border-t space-y-2">
                    <button onclick="exportData()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition-colors">
                        <i class="fas fa-download mr-2"></i>ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="importData()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded transition-colors">
                        <i class="fas fa-upload mr-2"></i>ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="resetData()" class="w-full bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded border border-red-200 transition-colors">
                        <i class="fas fa-redo mr-2"></i>åˆæœŸåŒ–ï¼ˆå…¨å‰Šé™¤ï¼‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ¼ãƒ‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cardModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeModal()">
        <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl">
            <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                <span class="font-bold" id="modalTitle">æ–°ã—ã„ã‚«ãƒ¼ãƒ‰</span>
                <button onclick="closeModal()" class="w-8 h-8 hover:bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 space-y-3 max-h-[70vh] overflow-y-auto">
                <div class="relative w-full h-40 border-2 border-dashed border-gray-300 rounded-xl overflow-hidden bg-gray-50">
                    <input type="file" id="imgInput" accept="image/*" class="absolute inset-0 opacity-0 z-10 cursor-pointer" onchange="handleImage(this)">
                    <div id="previewArea" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-gray-400">
                        <i class="fas fa-camera text-4xl mb-2"></i>
                        <span class="text-xs font-bold">ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸æŠ</span>
                    </div>
                    <img id="previewImg" class="absolute inset-0 w-full h-full object-contain bg-white hidden">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-600">ã‚«ãƒ¼ãƒ‰åï¼ˆæ¼¢å­—ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰<span class="text-red-500">*</span></label>
                    <input type="text" id="inputLabel" class="w-full p-2 border rounded mt-1 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none" placeholder="ä¾‹: ãŠé¢¨å‘‚ã«å…¥ã‚ŠãŸã„">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600">ã‚ˆã¿ãŒãªï¼ˆã²ã‚‰ãŒãªãƒ¢ãƒ¼ãƒ‰ãƒ»éŸ³å£°ç”¨ï¼‰</label>
                    <input type="text" id="inputTalk" class="w-full p-2 border rounded mt-1 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none" placeholder="ä¾‹: ãŠãµã‚ã«ã¯ã„ã‚ŠãŸã„">
                    <p class="text-[10px] text-gray-400 mt-1">â€»ç©ºæ¬„ã®å ´åˆã¯ã‚«ãƒ¼ãƒ‰åã‚’ä½¿ç”¨</p>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-600">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="inputCat" class="w-full p-2 border rounded mt-1 bg-white"></select>
                </div>
                <div class="flex items-center gap-2 pt-1">
                    <input type="checkbox" id="inputPin" class="w-4 h-4 text-blue-600 rounded">
                    <label for="inputPin" class="text-sm font-bold text-gray-700">
                        <i class="fas fa-star text-yellow-500"></i> ãŠæ°—ã«å…¥ã‚Šï¼ˆãƒ”ãƒ³ç•™ã‚ï¼‰
                    </label>
                </div>
            </div>
            <div class="p-3 bg-gray-50 border-t flex gap-2">
                <button id="delBtn" onclick="deleteCard()" class="px-3 py-2 text-red-600 bg-white border border-red-200 rounded hover:bg-red-50 transition-colors hidden">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button onclick="saveCard()" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 shadow-sm transition-colors">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="exportModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeExportModal()">
        <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl">
            <div class="bg-green-600 p-4 text-white flex justify-between items-center">
                <span class="font-bold"><i class="fas fa-download mr-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š</span>
                <button onclick="closeExportModal()" class="w-8 h-8 hover:bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <div>
                    <label class="text-sm font-bold text-gray-700 mb-2 block">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ã‚’é¸æŠ</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="exportType" value="all" checked class="w-4 h-4">
                            <span class="text-sm font-bold">ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="exportType" value="custom" class="w-4 h-4">
                            <span class="text-sm font-bold">è‡ªä½œã‚«ãƒ¼ãƒ‰ã®ã¿</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="exportType" value="default" class="w-4 h-4">
                            <span class="text-sm font-bold">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¼ãƒ‰ã®ã¿</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="exportType" value="pinned" class="w-4 h-4">
                            <span class="text-sm font-bold">ãŠæ°—ã«å…¥ã‚Šã®ã¿</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="exportType" value="category" class="w-4 h-4">
                            <span class="text-sm font-bold">é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªã®ã¿</span>
                        </label>
                    </div>
                </div>
                <div id="categorySelectArea" class="hidden">
                    <label class="text-sm font-bold text-gray-700 mb-2 block">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</label>
                    <select id="exportCategorySelect" class="w-full p-2 border rounded bg-white"></select>
                </div>
            </div>
            <div class="p-3 bg-gray-50 border-t">
                <button onclick="executeExport()" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 shadow-sm transition-colors">
                    <i class="fas fa-download mr-2"></i>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>

    <div id="toastArea"></div>
    <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleImport(this)">

    <script>
        // --- è¨­å®š ---
        const DB_KEY = 'pecs_pro_v6';
        const CONFIG_KEY = 'pecs_config_v2';
        
        let config = {
            mode: 'adult',
            gridSize: 'medium',
            sort: 'default'
        };

        let cards = [];
        let categories = [];
        let sentenceStrip = [];
        let currentFilter = 'all';
        let isPinFilter = false;
        let editingId = null;
        let tempImg = null;
        let isSpeaking = false;

        // --- åˆæœŸåŒ– ---
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadData();
            applyConfig();
            initSpeech();
            refreshUI();
            
            // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã®å¤‰æ›´ç›£è¦–
            document.querySelectorAll('input[name="exportType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const catArea = document.getElementById('categorySelectArea');
                    if(e.target.value === 'category') {
                        catArea.classList.remove('hidden');
                        renderExportCategorySelect();
                    } else {
                        catArea.classList.add('hidden');
                    }
                });
            });
        });

        function loadConfig() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if(saved) config = {...config, ...JSON.parse(saved)};
        }

        function saveConfig() {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
        }

        function loadData() {
            const raw = localStorage.getItem(DB_KEY);
            if(raw) {
                const data = JSON.parse(raw);
                cards = data.cards || [];
                categories = data.categories || [];
            } else {
                initDefaults();
            }
            if(categories.length === 0) initDefaults();
        }

        function saveData() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify({cards, categories}));
            } catch(e) {
                showToast('âš ï¸ ä¿å­˜å¤±æ•—ï¼ˆå®¹é‡ã‚ªãƒ¼ãƒãƒ¼ï¼‰');
            }
        }

        // --- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ ---
        function initDefaults() {
            categories = [
                {id: 'require', label: 'ãŠã­ãŒã„', color: 'cat-require'},
                {id: 'life', label: 'ã›ã„ã‹ã¤', color: 'cat-life'},
                {id: 'food', label: 'ãŸã¹ã‚‚ã®', color: 'cat-food'},
                {id: 'play', label: 'ã‚ãã³', color: 'cat-play'},
                {id: 'feeling', label: 'ãã‚‚ã¡', color: 'cat-feeling'},
                {id: 'other', label: 'ãã®ã»ã‹', color: 'cat-other'}
            ];

            const defaults = [
                // ãŠã­ãŒã„ï¼ˆå®Œçµå½¢ï¼‰
                {l:'ã€œãã ã•ã„', t:'ãã ã•ã„', c:'require', i:'ğŸ¤²', bg:'#FFFBEB', pin:true},
                {l:'æ‰‹ä¼ã£ã¦ãã ã•ã„', t:'ã¦ã¤ã ã£ã¦ãã ã•ã„', c:'require', i:'ğŸ¤', bg:'#FFFBEB', pin:true},
                {l:'ãŠã—ã¾ã„', t:'ãŠã—ã¾ã„ã§ã™', c:'require', i:'ğŸ™…', bg:'#FFFBEB'},
                {l:'ã‚‚ã†ä¸€å›', t:'ã‚‚ã†ã„ã£ã‹ã„', c:'require', i:'ğŸ”„', bg:'#FFFBEB'},
                {l:'å¾…ã£ã¦', t:'ã¾ã£ã¦ãã ã•ã„', c:'require', i:'âœ‹', bg:'#FFFBEB'},
                {l:'è¦‹ã›ã¦', t:'ã¿ã›ã¦', c:'require', i:'ğŸ‘€', bg:'#FFFBEB'},
                
                // ã›ã„ã‹ã¤ï¼ˆ1æšå®Œçµï¼‰
                {l:'ãƒˆã‚¤ãƒ¬ã«è¡ŒããŸã„', t:'ã¨ã„ã‚Œã«ã„ããŸã„ã§ã™', c:'life', i:'ğŸš½', bg:'#ECFDF5', pin:true},
                {l:'ãŠé¢¨å‘‚ã«å…¥ã‚ŠãŸã„', t:'ãŠãµã‚ã«ã¯ã„ã‚ŠãŸã„ã§ã™', c:'life', i:'ğŸ›', bg:'#ECFDF5'},
                {l:'æ‰‹ã‚’æ´—ã„ãŸã„', t:'ã¦ã‚’ã‚ã‚‰ã„ã¾ã™', c:'life', i:'ğŸ§¼', bg:'#ECFDF5'},
                {l:'ç€æ›¿ãˆãŸã„', t:'ããŒãˆãŸã„ã§ã™', c:'life', i:'ğŸ‘•', bg:'#ECFDF5'},
                {l:'å¯ãŸã„', t:'ã­ãŸã„ã§ã™', c:'life', i:'ğŸ˜´', bg:'#ECFDF5', pin:true},
                {l:'é›»æ°—ã‚’æ¶ˆã—ã¦', t:'ã§ã‚“ãã‚’ã‘ã—ã¦ãã ã•ã„', c:'life', i:'ğŸ’¡', bg:'#ECFDF5'},
                {l:'æš‘ã„', t:'ã‚ã¤ã„ã§ã™', c:'life', i:'ğŸ¥µ', bg:'#ECFDF5'},
                {l:'å¯’ã„', t:'ã•ã‚€ã„ã§ã™', c:'life', i:'ğŸ¥¶', bg:'#ECFDF5'},
                {l:'ãã¤ã‚’å±¥ã', t:'ãã¤ã‚’ã¯ãã¾ã™', c:'life', i:'ğŸ‘Ÿ', bg:'#ECFDF5'},
                {l:'æ­¯ç£¨ã', t:'ã¯ã¿ãŒãã—ã¾ã™', c:'life', i:'ğŸª¥', bg:'#ECFDF5'},
                
                // ãŸã¹ã‚‚ã®
                {l:'ã”ã¯ã‚“ãŒé£Ÿã¹ãŸã„', t:'ã”ã¯ã‚“ãŒãŸã¹ãŸã„ã§ã™', c:'food', i:'ğŸš', bg:'#FEF2F2', pin:true},
                {l:'ãŠã‚„ã¤ãŒé£Ÿã¹ãŸã„', t:'ãŠã‚„ã¤ãŒãŸã¹ãŸã„ã§ã™', c:'food', i:'ğŸª', bg:'#FEF2F2', pin:true},
                {l:'ãƒ‘ãƒ³', t:'ã±ã‚“', c:'food', i:'ğŸ', bg:'#FEF2F2'},
                {l:'ãƒãƒŠãƒŠ', t:'ã°ãªãª', c:'food', i:'ğŸŒ', bg:'#FEF2F2'},
                {l:'ã‚Šã‚“ã”', t:'ã‚Šã‚“ã”', c:'food', i:'ğŸ', bg:'#FEF2F2'},
                {l:'ã‚¼ãƒªãƒ¼', t:'ãœã‚Šãƒ¼', c:'food', i:'ğŸ®', bg:'#FEF2F2'},
                {l:'ã‚¢ã‚¤ã‚¹', t:'ã‚ã„ã™ãã‚Šãƒ¼ã‚€', c:'food', i:'ğŸ¦', bg:'#FEF2F2'},
                {l:'æ°´ãŒé£²ã¿ãŸã„', t:'ã¿ãšãŒã®ã¿ãŸã„ã§ã™', c:'food', i:'ğŸ’§', bg:'#FEF2F2'},
                {l:'ãŠèŒ¶', t:'ãŠã¡ã‚ƒ', c:'food', i:'ğŸµ', bg:'#FEF2F2'},
                {l:'ã‚¸ãƒ¥ãƒ¼ã‚¹', t:'ã˜ã‚…ãƒ¼ã™', c:'food', i:'ğŸ§ƒ', bg:'#FEF2F2'},
                {l:'ç‰›ä¹³', t:'ãã‚…ã†ã«ã‚…ã†', c:'food', i:'ğŸ¥›', bg:'#FEF2F2'},
                
                // ã‚ãã³
                {l:'YouTubeè¦‹ãŸã„', t:'ã‚†ãƒ¼ã¡ã‚…ãƒ¼ã¶ãŒã¿ãŸã„ã§ã™', c:'play', i:'ğŸ“º', bg:'#EFF6FF', pin:true},
                {l:'iPadä½¿ã„ãŸã„', t:'ã‚ã„ã±ã£ã©ãŒã¤ã‹ã„ãŸã„ã§ã™', c:'play', i:'ğŸ“±', bg:'#EFF6FF', pin:true},
                {l:'ãƒ–ãƒ­ãƒƒã‚¯', t:'ã¶ã‚ã£ã', c:'play', i:'ğŸ§±', bg:'#EFF6FF'},
                {l:'ã¬ã„ãã‚‹ã¿', t:'ã¬ã„ãã‚‹ã¿', c:'play', i:'ğŸ§¸', bg:'#EFF6FF'},
                {l:'ãƒŸãƒ‹ã‚«ãƒ¼', t:'ã¿ã«ã‹ãƒ¼', c:'play', i:'ğŸš—', bg:'#EFF6FF'},
                {l:'ãƒœãƒ¼ãƒ«', t:'ã¼ãƒ¼ã‚‹', c:'play', i:'âš½', bg:'#EFF6FF'},
                {l:'çµµæœ¬', t:'ãˆã»ã‚“', c:'play', i:'ğŸ“–', bg:'#EFF6FF'},
                {l:'ãŠçµµæã', t:'ãŠãˆã‹ã', c:'play', i:'ğŸ–ï¸', bg:'#EFF6FF'},
                {l:'å…¬åœ’ã«è¡ŒããŸã„', t:'ã“ã†ãˆã‚“ã«ã„ããŸã„ã§ã™', c:'play', i:'ğŸ›', bg:'#EFF6FF'},
                {l:'ã‚·ãƒ£ãƒœãƒ³ç‰', t:'ã—ã‚ƒã¼ã‚“ã ã¾', c:'play', i:'ğŸ«§', bg:'#EFF6FF'},
                {l:'éŸ³æ¥½', t:'ãŠã‚“ãŒã', c:'play', i:'ğŸµ', bg:'#EFF6FF'},
                
                // ãã‚‚ã¡ãƒ»ã²ã¨
                {l:'ç—›ã„', t:'ã„ãŸã„ã§ã™', c:'feeling', i:'ğŸ¤•', bg:'#F5F3FF', pin:true},
                {l:'ã‚¤ãƒ¤', t:'ã„ã‚„ã§ã™', c:'feeling', i:'ğŸ˜ ', bg:'#F5F3FF'},
                {l:'æ¥½ã—ã„', t:'ãŸã®ã—ã„', c:'feeling', i:'ğŸ˜„', bg:'#F5F3FF'},
                {l:'æ‚²ã—ã„', t:'ã‹ãªã—ã„', c:'feeling', i:'ğŸ˜¢', bg:'#F5F3FF'},
                {l:'æ€–ã„', t:'ã“ã‚ã„', c:'feeling', i:'ğŸ˜¨', bg:'#F5F3FF'},
                {l:'ãŠæ¯ã•ã‚“', t:'ãŠã‹ã‚ã•ã‚“', c:'feeling', i:'ğŸ‘©', bg:'#F5F3FF'},
                {l:'ãŠçˆ¶ã•ã‚“', t:'ãŠã¨ã†ã•ã‚“', c:'feeling', i:'ğŸ‘¨', bg:'#F5F3FF'},
                {l:'å…ˆç”Ÿ', t:'ã›ã‚“ã›ã„', c:'feeling', i:'ğŸ§‘â€ğŸ«', bg:'#F5F3FF'},
                
                // ãã®ã»ã‹
                {l:'ç—…é™¢', t:'ã³ã‚‡ã†ã„ã‚“', c:'other', i:'ğŸ¥', bg:'#F9FAFB'},
                {l:'å­¦æ ¡', t:'ãŒã£ã“ã†', c:'other', i:'ğŸ«', bg:'#F9FAFB'},
                {l:'ãŠåº—', t:'ãŠã¿ã›', c:'other', i:'ğŸª', bg:'#F9FAFB'},
                {l:'å®¶ã«å¸°ã‚‹', t:'ã„ãˆã«ã‹ãˆã‚Šã¾ã™', c:'other', i:'ğŸ ', bg:'#F9FAFB'}
            ];

            cards = defaults.map((d, i) => ({
                id: 'def_' + i,
                label: d.l,
                talk: d.t,
                category: d.c,
                image: createIcon(d.i, d.bg),
                isDefault: true,
                pin: d.pin || false,
                useCount: 0,
                timestamp: Date.now() - (defaults.length - i) * 1000
            }));
            saveData();
        }

        function createIcon(icon, bg) {
            const cvs = document.createElement('canvas');
            cvs.width = 300; cvs.height = 300;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = bg;
            ctx.fillRect(0,0,300,300);
            ctx.font = '160px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = "rgba(0,0,0,0.15)";
            ctx.shadowBlur = 8;
            ctx.shadowOffsetY = 4;
            ctx.fillText(icon, 150, 150);
            return cvs.toDataURL('image/jpeg', 0.8);
        }

        // --- UIé©ç”¨ ---
        function applyConfig() {
            const body = document.body;
            const modeBadge = document.getElementById('modeBadge');
            const childBtn = document.getElementById('modeChildBtn');
            const adultBtn = document.getElementById('modeAdultBtn');

            // ãƒ¢ãƒ¼ãƒ‰
            if(config.mode === 'child') {
                modeBadge.textContent = 'ã²ã‚‰ãŒãª';
                modeBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-green-100 text-green-600 font-bold";
                if(childBtn) {
                    childBtn.className = "py-2 rounded-lg text-sm font-bold border-2 bg-green-50 border-green-500 text-green-700";
                    adultBtn.className = "py-2 rounded-lg text-sm font-bold border-2 border-gray-300 text-gray-500";
                }
            } else {
                modeBadge.textContent = 'æ¼¢å­—';
                modeBadge.className = "text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-bold";
                if(adultBtn) {
                    adultBtn.className = "py-2 rounded-lg text-sm font-bold border-2 bg-blue-50 border-blue-500 text-blue-700";
                    childBtn.className = "py-2 rounded-lg text-sm font-bold border-2 border-gray-300 text-gray-500";
                }
            }

            // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º
            body.className = body.className.replace(/grid-\w+-?\w*/g, '');
            body.classList.add('grid-' + config.gridSize);
            
            const sizeButtons = {
                'x-small': 'sizeXS',
                'small': 'sizeS',
                'medium': 'sizeM',
                'large': 'sizeL',
                'x-large': 'sizeXL'
            };
            
            Object.entries(sizeButtons).forEach(([size, btnId]) => {
                const btn = document.getElementById(btnId);
                if(btn) {
                    if(size === config.gridSize) {
                        btn.className = "flex-1 py-2 rounded text-xs font-bold border-2 bg-blue-50 border-blue-500 text-blue-700";
                    } else {
                        btn.className = "flex-1 py-2 rounded text-xs font-bold border border-gray-300 text-gray-600 hover:bg-gray-50";
                    }
                }
            });

            // ã‚½ãƒ¼ãƒˆ
            const sortSel = document.getElementById('sortSelect');
            if(sortSel) sortSel.value = config.sort;

            saveConfig();
            refreshUI();
        }

        function setMode(mode) {
            config.mode = mode;
            applyConfig();
        }

        function setGridSize(size) {
            config.gridSize = size;
            applyConfig();
        }

        function setSort(sort) {
            config.sort = sort;
            saveConfig();
            refreshUI();
        }

        // --- UIæç”» ---
        function refreshUI() {
            renderCategoryBar();
            renderCardGrid();
            renderStrip();
        }

        function renderCategoryBar() {
            const bar = document.getElementById('categoryBar');
            const all = [{id: 'all', label: 'ã™ã¹ã¦'}, ...categories];
            bar.innerHTML = all.map(cat => `
                <button onclick="setFilter('${cat.id}')" class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all ${
                    currentFilter === cat.id 
                    ? 'bg-blue-600 text-white shadow-md' 
                    : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'
                }">
                    ${cat.label}
                </button>
            `).join('');
        }

        function setFilter(id) {
            currentFilter = id;
            isPinFilter = false;
            document.getElementById('pinFilterBtn').classList.remove('text-yellow-500');
            refreshUI();
        }

        function togglePinFilter() {
            isPinFilter = !isPinFilter;
            const btn = document.getElementById('pinFilterBtn');
            if(isPinFilter) {
                btn.classList.add('text-yellow-500');
                currentFilter = 'all';
            } else {
                btn.classList.remove('text-yellow-500');
            }
            refreshUI();
        }

        function renderCardGrid() {
            const grid = document.getElementById('cardGrid');
            const empty = document.getElementById('emptyState');
            
            let list = cards.filter(c => {
                if(isPinFilter) return c.pin;
                if(currentFilter === 'all') return true;
                return c.category === currentFilter;
            });

            // ã‚½ãƒ¼ãƒˆ
            list.sort((a, b) => {
                if(config.sort === 'default') {
                    if(a.pin && !b.pin) return -1;
                    if(!a.pin && b.pin) return 1;
                    return b.timestamp - a.timestamp;
                }
                if(config.sort === 'aiueo') {
                    return a.talk.localeCompare(b.talk, 'ja');
                }
                if(config.sort === 'category') {
                    if(a.category !== b.category) return a.category.localeCompare(b.category);
                    return 0;
                }
                if(config.sort === 'frequency') {
                    return (b.useCount||0) - (a.useCount||0);
                }
                return 0;
            });

            if(list.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                empty.classList.add('flex');
                return;
            }
            empty.classList.add('hidden');
            empty.classList.remove('flex');

            grid.innerHTML = list.map(c => {
                const catObj = categories.find(cat => cat.id === c.category) || {color:'cat-other'};
                const dispName = (config.mode === 'child') ? c.talk : c.label;

                return `
                <div class="pecs-card rounded-xl overflow-hidden flex flex-col shadow-md ${catObj.color} aspect-[3/4]" onclick="addToStrip('${c.id}')">
                    ${c.pin ? '<i class="fas fa-star pin-badge"></i>' : ''}
                    <div class="absolute top-1 right-1 z-10">
                        <button onclick="event.stopPropagation(); openEditModal('${c.id}')" class="w-7 h-7 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center text-gray-400 hover:text-blue-600 shadow border border-gray-200 transition-colors">
                            <i class="fas fa-ellipsis-h text-xs"></i>
                        </button>
                    </div>
                    <div class="flex-1 bg-white p-2 flex items-center justify-center overflow-hidden">
                        <img src="${c.image}" class="w-full h-full object-contain pointer-events-none">
                    </div>
                    <div class="h-10 flex items-center justify-center bg-white/95 border-t border-gray-200 px-2">
                        <span class="text-sm font-bold text-center line-clamp-2 leading-tight">${dispName}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStrip() {
            const strip = document.getElementById('sentenceStrip');
            const ph = document.getElementById('stripPlaceholder');
            
            strip.querySelectorAll('.strip-item').forEach(e => e.remove());

            if(sentenceStrip.length === 0) {
                ph.style.display = 'flex';
                return;
            }
            ph.style.display = 'none';

            sentenceStrip.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = "strip-item flex-shrink-0 w-24 bg-white rounded-lg border-2 border-gray-300 shadow overflow-hidden flex flex-col cursor-pointer transition-all hover:border-blue-400";
                div.id = `strip-${idx}`;
                div.onclick = () => removeStripItem(idx);
                
                const dispName = (config.mode === 'child') ? c.talk : c.label;
                
                div.innerHTML = `
                    <div class="flex-1 p-2 flex items-center justify-center bg-white">
                        <img src="${c.image}" class="max-w-full max-h-full object-contain">
                    </div>
                    <div class="h-7 bg-gray-50 flex items-center justify-center text-[10px] font-bold px-1 border-t">
                        <span class="truncate w-full text-center">${dispName}</span>
                    </div>
                `;
                strip.appendChild(div);
            });
            
            setTimeout(() => strip.scrollTo({left: strip.scrollWidth, behavior:'smooth'}), 50);
        }

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        function addToStrip(id) {
            const c = cards.find(x => x.id === id);
            if(c) {
                sentenceStrip.push({...c});
                c.useCount = (c.useCount || 0) + 1;
                saveData();
                renderStrip();
            }
        }

        function removeStripItem(idx) {
            sentenceStrip.splice(idx, 1);
            renderStrip();
        }

        function popLast() {
            if(sentenceStrip.length > 0) {
                sentenceStrip.pop();
                renderStrip();
            }
        }

        function clearAll() {
            if(sentenceStrip.length > 0 && confirm('æ–‡ã‚’ã™ã¹ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sentenceStrip = [];
                renderStrip();
            }
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ« ---
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function openCardModal() {
            editingId = null;
            tempImg = null;
            document.getElementById('cardModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = 'æ–°ã—ã„ã‚«ãƒ¼ãƒ‰';
            document.getElementById('inputLabel').value = '';
            document.getElementById('inputTalk').value = '';
            document.getElementById('inputPin').checked = false;
            document.getElementById('previewImg').classList.add('hidden');
            document.getElementById('previewArea').classList.remove('hidden');
            document.getElementById('delBtn').classList.add('hidden');
            renderCatSelect('require');
        }

        function openEditModal(id) {
            const c = cards.find(x => x.id === id);
            if(!c) return;
            
            editingId = id;
            tempImg = c.image;
            document.getElementById('cardModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = 'ã‚«ãƒ¼ãƒ‰ç·¨é›†';
            document.getElementById('inputLabel').value = c.label;
            document.getElementById('inputTalk').value = c.talk;
            document.getElementById('inputPin').checked = c.pin || false;
            
            const img = document.getElementById('previewImg');
            img.src = c.image;
            img.classList.remove('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('delBtn').classList.remove('hidden');
            
            renderCatSelect(c.category);
        }

        function closeModal() {
            document.getElementById('cardModal').classList.add('hidden');
        }

        function renderCatSelect(selId) {
            const sel = document.getElementById('inputCat');
            sel.innerHTML = categories.map(c => 
                `<option value="${c.id}" ${c.id===selId?'selected':''}>${c.label}</option>`
            ).join('');
        }

        function handleImage(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                resizeImage(e.target.result, res => {
                    tempImg = res;
                    const img = document.getElementById('previewImg');
                    img.src = res;
                    img.classList.remove('hidden');
                    document.getElementById('previewArea').classList.add('hidden');
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        function resizeImage(base64, cb) {
            const img = new Image();
            img.src = base64;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const MAX = 500;
                let w = img.width, h = img.height;
                if(w > h) {
                    if(w > MAX) { h *= MAX/w; w = MAX; }
                } else {
                    if(h > MAX) { w *= MAX/h; h = MAX; }
                }
                cvs.width = w;
                cvs.height = h;
                const ctx = cvs.getContext('2d');
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, 0, 0, w, h);
                cb(cvs.toDataURL('image/jpeg', 0.75));
            };
        }

        function saveCard() {
            const lbl = document.getElementById('inputLabel').value.trim();
            let tlk = document.getElementById('inputTalk').value.trim();
            const cat = document.getElementById('inputCat').value;
            const pin = document.getElementById('inputPin').checked;

            if(!lbl) return alert('ã‚«ãƒ¼ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if(!tempImg) return alert('ç”»åƒã‚’è¨­å®šã—ã¦ãã ã•ã„');
            if(!tlk) tlk = lbl;

            const newData = {
                id: editingId || 'usr_' + Date.now(),
                label: lbl,
                talk: tlk,
                category: cat,
                image: tempImg,
                pin: pin,
                isDefault: editingId ? (cards.find(c=>c.id===editingId)?.isDefault||false) : false,
                useCount: editingId ? (cards.find(c=>c.id===editingId)?.useCount||0) : 0,
                timestamp: Date.now()
            };

            if(editingId) {
                cards = cards.map(c => c.id === editingId ? newData : c);
            } else {
                cards.push(newData);
            }
            saveData();
            closeModal();
            refreshUI();
            showToast('âœ… ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function deleteCard() {
            if(confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                cards = cards.filter(c => c.id !== editingId);
                saveData();
                closeModal();
                refreshUI();
                showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // --- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---
        function exportData() {
            document.getElementById('settingsPanel').classList.add('hidden');
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function renderExportCategorySelect() {
            const sel = document.getElementById('exportCategorySelect');
            sel.innerHTML = categories.map(c => 
                `<option value="${c.id}">${c.label}</option>`
            ).join('');
        }

        function executeExport() {
            const type = document.querySelector('input[name="exportType"]:checked').value;
            let exportCards = [];

            if(type === 'all') {
                exportCards = cards;
            } else if(type === 'custom') {
                exportCards = cards.filter(c => !c.isDefault);
            } else if(type === 'default') {
                exportCards = cards.filter(c => c.isDefault);
            } else if(type === 'pinned') {
                exportCards = cards.filter(c => c.pin);
            } else if(type === 'category') {
                const catId = document.getElementById('exportCategorySelect').value;
                exportCards = cards.filter(c => c.category === catId);
            }

            if(exportCards.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const data = {
                cards: exportCards,
                categories: categories,
                exportDate: new Date().toISOString(),
                exportType: type
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pecs-cards-${type}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            closeExportModal();
            showToast(`ğŸ“¦ ${exportCards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        }

        function importData() {
            document.getElementById('settingsPanel').classList.add('hidden');
            document.getElementById('importFileInput').click();
        }

        function handleImport(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!data.cards || !Array.isArray(data.cards)) {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼');
                    }
                    
                    const msg = `${data.cards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ï¼ˆé‡è¤‡ã‚«ãƒ¼ãƒ‰ã¯è¿½åŠ ã•ã‚Œã¾ã™ï¼‰`;
                    if(!confirm(msg)) return;

                    // ã‚«ãƒ†ã‚´ãƒªã‚’ãƒãƒ¼ã‚¸
                    if(data.categories && Array.isArray(data.categories)) {
                        data.categories.forEach(newCat => {
                            if(!categories.find(c => c.id === newCat.id)) {
                                categories.push(newCat);
                            }
                        });
                    }

                    // ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆIDã‚’æ–°è¦ç”Ÿæˆã—ã¦é‡è¤‡å›é¿ï¼‰
                    data.cards.forEach(card => {
                        cards.push({
                            ...card,
                            id: 'imp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            timestamp: Date.now()
                        });
                    });

                    saveData();
                    refreshUI();
                    showToast(`âœ… ${data.cards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                } catch(err) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ\n' + err.message);
                }
            };
            reader.readAsText(input.files[0]);
            input.value = '';
        }

        function resetData() {
            if(confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“')) {
                if(confirm('æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem(DB_KEY);
                    location.reload();
                }
            }
        }

        // --- éŸ³å£°å†ç”Ÿ ---
        function initSpeech() {
            if('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
            }
        }

        function playSentence() {
            if(sentenceStrip.length === 0 || isSpeaking) return;

            isSpeaking = true;
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="text-lg font-bold">æº–å‚™ä¸­...</span>';
            btn.classList.add('bg-gray-400');
            btn.classList.remove('bg-blue-600');

            window.speechSynthesis.cancel();
            const wake = new SpeechSynthesisUtterance('');
            window.speechSynthesis.speak(wake);

            setTimeout(() => {
                speakQueue(0);
            }, 300);
        }

        function speakQueue(idx) {
            if(idx >= sentenceStrip.length) {
                stopSpeaking();
                return;
            }

            const card = sentenceStrip[idx];
            const stripCard = document.getElementById(`strip-${idx}`);
            if(stripCard) stripCard.classList.add('playing-highlight');

            const voices = window.speechSynthesis.getVoices();
            const jpVoice = voices.find(v => v.lang === 'ja-JP') || voices[0];

            const utterance = new SpeechSynthesisUtterance(card.talk);
            utterance.voice = jpVoice;
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            utterance.pitch = 1.1;

            utterance.onend = () => {
                if(stripCard) stripCard.classList.remove('playing-highlight');
                setTimeout(() => speakQueue(idx + 1), 300);
            };

            utterance.onerror = () => {
                if(stripCard) stripCard.classList.remove('playing-highlight');
                stopSpeaking();
            };

            window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            isSpeaking = false;
            window.speechSynthesis.cancel();
            document.querySelectorAll('.playing-highlight').forEach(el => 
                el.classList.remove('playing-highlight')
            );
            const btn = document.getElementById('playBtn');
            btn.innerHTML = '<i class="fas fa-volume-up text-2xl"></i> <span class="text-lg font-bold">ãŠã¯ãªã—</span>';
            btn.classList.remove('bg-gray-400');
            btn.classList.add('bg-blue-600');
        }

        // --- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ---
        function showToast(msg) {
            const area = document.getElementById('toastArea');
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = msg;
            area.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>
