<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PECS Board Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .pecs-card {
            transition: all 0.15s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            position: relative;
            touch-action: manipulation;
        }
        .pecs-card:active { transform: scale(0.96); }
        
        .pin-badge {
            position: absolute; top: 6px; left: 6px;
            color: #F59E0B; font-size: 16px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            z-index: 10;
        }

        /* ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ */
        .cat-require { border: 3px solid #F59E0B; background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%); }
        .cat-life { border: 2px solid #10B981; background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); }
        .cat-food { border: 2px solid #EF4444; background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%); }
        .cat-play { border: 2px solid #3B82F6; background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); }
        .cat-feeling { border: 2px solid #8B5CF6; background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%); }
        .cat-color { border: 2px solid #EC4899; background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%); }
        .cat-other { border: 2px solid #6B7280; background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%); }

        .playing-highlight {
            border-color: #EF4444 !important;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4);
            transform: scale(1.05);
            z-index: 20;
        }
        
        .toast {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95); color: white;
            padding: 12px 24px; border-radius: 999px;
            font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out;
            z-index: 9999; pointer-events: none;
        }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º */
        .grid-x-small .card-grid { grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .grid-small .card-grid { grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .grid-medium .card-grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .grid-large .card-grid { grid-template-columns: repeat(3, 1fr); gap: 14px; }
        .grid-x-large .card-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
        
        @media (max-width: 640px) {
            .grid-x-small .card-grid { grid-template-columns: repeat(5, 1fr); }
            .grid-small .card-grid { grid-template-columns: repeat(4, 1fr); }
            .grid-medium .card-grid { grid-template-columns: repeat(3, 1fr); }
            .grid-large .card-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-x-large .card-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Canvasæç”»ã‚¨ãƒªã‚¢ */
        #drawCanvas {
            border: 2px dashed #cbd5e0;
            cursor: crosshair;
            touch-action: none;
        }

        /* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ */
        .emoji-category {
            max-height: 200px;
            overflow-y: auto;
        }

        .strip-card {
            cursor: pointer;
            transition: all 0.15s;
        }
        .strip-card:hover {
            transform: scale(0.95);
            opacity: 0.8;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-gray-50">

    <header class="bg-white shadow-sm z-10 flex-none border-b">
        <div class="p-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <button onclick="toggleSettings()" class="text-gray-600 hover:text-blue-600 p-1">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 id="appTitle" class="text-lg font-bold text-gray-700">PECS Pro</h1>
                <span id="modeBadge" class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-bold">æ¼¢å­—</span>
            </div>
            <div class="flex gap-2">
                <button onclick="togglePinFilter()" id="pinFilterBtn" class="text-gray-400 hover:text-yellow-500 p-2 rounded-lg transition-colors">
                    <i class="fas fa-star text-lg"></i>
                </button>
                <button onclick="openCardModal()" id="addCardBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-all active:scale-95">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">ä½œã‚‹</span>
                </button>
            </div>
        </div>
        <div class="px-3 pb-2 flex gap-2 overflow-x-auto hide-scrollbar" id="categoryBar"></div>
    </header>

    <main class="flex-1 overflow-y-auto p-3" style="padding-bottom: 220px;" id="mainContainer">
        <div id="cardGrid" class="card-grid grid"></div>
        <div id="emptyState" class="hidden flex-col items-center justify-center mt-20 text-gray-400">
            <i class="fas fa-box-open text-6xl mb-4"></i>
            <p id="emptyText" class="font-bold">ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-blue-200 shadow-xl z-20">
        <div id="sentenceStrip" class="flex items-center p-2 gap-2 bg-gradient-to-r from-yellow-50 to-orange-50 overflow-x-auto hide-scrollbar min-h-[110px] relative">
            <div id="stripPlaceholder" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 font-bold">
                <i class="fas fa-hand-pointer mr-2"></i> <span id="stripPlaceholderText">ã‚«ãƒ¼ãƒ‰ã‚’ãªã‚‰ã¹ã¦ã­</span>
            </div>
        </div>
        <div class="grid grid-cols-5 gap-2 p-2 bg-gray-50">
            <button onclick="popLast()" id="popBtn" class="bg-white border-2 border-gray-300 text-gray-600 rounded-lg py-2 flex flex-col items-center active:bg-gray-100 transition-colors">
                <i class="fas fa-backspace text-lg"></i>
                <span class="text-[10px] font-bold mt-1">1ã¤æ¶ˆã™</span>
            </button>
            <button onclick="clearAll()" id="clearBtn" class="bg-red-50 border-2 border-red-200 text-red-600 rounded-lg py-2 flex flex-col items-center active:bg-red-100 transition-colors">
                <i class="fas fa-trash-alt text-lg"></i>
                <span class="text-[10px] font-bold mt-1">å…¨æ¶ˆã—</span>
            </button>
            <button onclick="playSentence()" id="playBtn" class="col-span-3 bg-blue-600 text-white rounded-lg py-2 shadow-md flex items-center justify-center gap-2 active:bg-blue-700 active:scale-95 transition-all">
                <i class="fas fa-volume-up text-2xl"></i>
                <span id="playBtnText" class="text-lg font-bold">ãŠã¯ãªã—</span>
            </button>
        </div>
    </footer>

    <!-- è¨­å®šãƒ‘ãƒãƒ« -->
    <div id="settingsPanel" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center" onclick="if(event.target===this) toggleSettings()">
        <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl overflow-hidden shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-4 text-white flex justify-between items-center">
                <span id="settingsTitle" class="font-bold text-lg"><i class="fas fa-cog mr-2"></i>è¨­å®š</span>
                <button onclick="toggleSettings()" class="w-8 h-8 hover:bg-white/20 rounded-full flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
                <div>
                    <label id="modeLabel" class="text-xs font-bold text-gray-600 mb-2 block">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="modeChildBtn" onclick="setMode('child')" class="py-2 rounded-lg text-sm font-bold border-2 transition-all">
                            <i class="fas fa-child mr-1"></i><span id="modeChildText">ã²ã‚‰ãŒãª</span>
                        </button>
                        <button id="modeAdultBtn" onclick="setMode('adult')" class="py-2 rounded-lg text-sm font-bold border-2 transition-all">
                            <i class="fas fa-user mr-1"></i><span id="modeAdultText">æ¼¢å­—</span>
                        </button>
                    </div>
                </div>

                <!-- ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º -->
                <div>
                    <label id="sizeLabel" class="text-xs font-bold text-gray-600 mb-2 block">ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º</label>
                    <div class="flex gap-2">
                        <button onclick="setGridSize('x-small')" id="sizeXS" class="flex-1 py-2 rounded text-xs font-bold border transition-all">æ¥µå°</button>
                        <button onclick="setGridSize('small')" id="sizeS" class="flex-1 py-2 rounded text-xs font-bold border transition-all">å°</button>
                        <button onclick="setGridSize('medium')" id="sizeM" class="flex-1 py-2 rounded text-xs font-bold border transition-all">ä¸­</button>
                        <button onclick="setGridSize('large')" id="sizeL" class="flex-1 py-2 rounded text-xs font-bold border transition-all">å¤§</button>
                        <button onclick="setGridSize('x-large')" id="sizeXL" class="flex-1 py-2 rounded text-xs font-bold border transition-all">ç‰¹å¤§</button>
                    </div>
                </div>

                <!-- ä¸¦ã³é † -->
                <div>
                    <label id="sortLabel" class="text-xs font-bold text-gray-600 mb-2 block">ä¸¦ã³é †</label>
                    <select id="sortSelect" onchange="setSort(this.value)" class="w-full p-2 border rounded bg-white text-sm">
                        <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ”ãƒ³å„ªå…ˆâ†’æ–°ã—ã„é †ï¼‰</option>
                        <option value="name-asc">åå‰é †ï¼ˆã‚ã„ã†ãˆãŠï¼‰</option>
                        <option value="name-desc">åå‰é †ï¼ˆé€†é †ï¼‰</option>
                        <option value="category">ã‚«ãƒ†ã‚´ãƒªã”ã¨</option>
                        <option value="usage">ä½¿ç”¨é »åº¦é †</option>
                    </select>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                <div>
                    <label id="dataLabel" class="text-xs font-bold text-gray-600 mb-2 block">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openExportModal()" id="exportBtn" class="py-2 px-3 bg-green-50 border border-green-300 text-green-700 rounded-lg text-sm font-bold hover:bg-green-100 transition-colors">
                            <i class="fas fa-download mr-1"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button onclick="importData()" id="importBtn" class="py-2 px-3 bg-blue-50 border border-blue-300 text-blue-700 rounded-lg text-sm font-bold hover:bg-blue-100 transition-colors">
                            <i class="fas fa-upload mr-1"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                    <button onclick="resetData()" id="resetBtn" class="w-full mt-2 py-2 bg-red-50 border border-red-300 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition-colors">
                        <i class="fas fa-trash mr-1"></i>ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
                    </button>
                </div>

                <!-- Buy Me a Coffeeï¼ˆæ¼¢å­—ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="coffeeSection" class="hidden">
                    <label class="text-xs font-bold text-gray-600 mb-2 block">ã‚µãƒãƒ¼ãƒˆ</label>
                    <a href="https://buymeacoffee.com/yoshida" target="_blank" class="block w-full py-3 bg-yellow-50 border-2 border-yellow-400 text-yellow-800 rounded-lg text-sm font-bold hover:bg-yellow-100 transition-colors text-center">
                        <i class="fas fa-coffee mr-2"></i>é–‹ç™ºè€…ã«ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’å¥¢ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ¼ãƒ‰ä½œæˆ/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cardModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center" onclick="if(event.target===this) closeCardModal()">
        <div class="bg-white w-full sm:max-w-lg rounded-t-2xl sm:rounded-2xl overflow-hidden shadow-2xl max-h-[85vh] flex flex-col">
            <div class="bg-gradient-to-r from-blue-600 to-blue-500 p-4 text-white flex justify-between items-center flex-none">
                <span id="modalTitle" class="font-bold text-lg"><i class="fas fa-plus-circle mr-2"></i>ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹</span>
                <button onclick="closeCardModal()" class="w-8 h-8 hover:bg-white/20 rounded-full flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 space-y-3 overflow-y-auto flex-1">
                <input type="hidden" id="editCardId">
                
                <!-- ç”»åƒé¸æŠ -->
                <div>
                    <label id="imageLabel" class="text-xs font-bold text-gray-600 mb-2 block">çµµãƒ»ç”»åƒ</label>
                    <div class="flex gap-2 mb-2">
                        <button onclick="selectImageType('emoji')" id="imageTypeEmoji" class="flex-1 py-2 px-3 border-2 rounded-lg text-sm font-bold transition-all">
                            ğŸ˜Š <span id="emojiText">çµµæ–‡å­—</span>
                        </button>
                        <button onclick="selectImageType('file')" id="imageTypeFile" class="flex-1 py-2 px-3 border-2 rounded-lg text-sm font-bold transition-all">
                            ğŸ“· <span id="fileText">å†™çœŸ</span>
                        </button>
                        <button onclick="selectImageType('canvas')" id="imageTypeCanvas" class="flex-1 py-2 px-3 border-2 rounded-lg text-sm font-bold transition-all">
                            ğŸ¨ <span id="canvasText">æã</span>
                        </button>
                    </div>
                    
                    <!-- çµµæ–‡å­—é¸æŠ -->
                    <div id="emojiPicker" class="hidden">
                        <input type="text" id="emojiInput" placeholder="çµµæ–‡å­—ã‚’é¸æŠ..." class="w-full p-3 border rounded-lg text-4xl text-center mb-2" readonly>
                        
                        <!-- ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
                        <div class="flex gap-1 mb-2 overflow-x-auto hide-scrollbar">
                            <button onclick="showEmojiCategory('smileys')" class="emoji-cat-btn px-3 py-1 text-lg rounded bg-blue-100">ğŸ˜Š</button>
                            <button onclick="showEmojiCategory('animals')" class="emoji-cat-btn px-3 py-1 text-lg rounded">ğŸ¶</button>
                            <button onclick="showEmojiCategory('food')" class="emoji-cat-btn px-3 py-1 text-lg rounded">ğŸ</button>
                            <button onclick="showEmojiCategory('activities')" class="emoji-cat-btn px-3 py-1 text-lg rounded">âš½</button>
                            <button onclick="showEmojiCategory('travel')" class="emoji-cat-btn px-3 py-1 text-lg rounded">ğŸš—</button>
                            <button onclick="showEmojiCategory('objects')" class="emoji-cat-btn px-3 py-1 text-lg rounded">ğŸ’¡</button>
                            <button onclick="showEmojiCategory('symbols')" class="emoji-cat-btn px-3 py-1 text-lg rounded">â¤ï¸</button>
                        </div>

                        <!-- çµµæ–‡å­—ã‚°ãƒªãƒƒãƒ‰ -->
                        <div id="emojiGrid" class="grid grid-cols-8 gap-1 emoji-category"></div>
                    </div>
                    
                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
                    <div id="filePicker" class="hidden">
                        <input type="file" id="imageFileInput" accept="image/*" onchange="handleImageFile(this)" class="w-full p-2 border rounded-lg text-sm">
                        <div id="imagePreview" class="mt-2 hidden">
                            <img id="previewImg" class="w-full h-32 object-contain border rounded-lg bg-gray-50">
                        </div>
                    </div>
                    
                    <!-- Canvasæç”» -->
                    <div id="canvasPicker" class="hidden">
                        <div class="mb-2 flex gap-2">
                            <input type="color" id="drawColor" value="#000000" class="w-12 h-8 border rounded cursor-pointer">
                            <input type="range" id="drawWidth" min="1" max="20" value="3" class="flex-1">
                            <button onclick="clearCanvas()" class="px-3 py-1 bg-gray-200 rounded text-sm font-bold">ã‚¯ãƒªã‚¢</button>
                        </div>
                        <canvas id="drawCanvas" width="300" height="200" class="w-full bg-white rounded-lg"></canvas>
                    </div>
                </div>

                <!-- æ¼¢å­— -->
                <div>
                    <label id="kanjiLabel" class="text-xs font-bold text-gray-600 mb-1 block">æ¼¢å­—</label>
                    <input type="text" id="kanjiInput" placeholder="ä¾‹: ãƒˆã‚¤ãƒ¬" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" oninput="autoConvertToHiragana(this.value)">
                </div>

                <!-- ã²ã‚‰ãŒãª -->
                <div>
                    <label id="hiraganaLabel" class="text-xs font-bold text-gray-600 mb-1 block">ã²ã‚‰ãŒãª</label>
                    <input type="text" id="hiraganaInput" placeholder="ä¾‹: ã¨ã„ã‚Œ" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- èª­ã¿ä¸Šã’ -->
                <div>
                    <label id="talkLabel" class="text-xs font-bold text-gray-600 mb-1 block">èª­ã¿ä¸Šã’ï¼ˆçœç•¥å¯ï¼‰</label>
                    <input type="text" id="talkInput" placeholder="çœç•¥æ™‚ã¯æ¼¢å­—ãŒèª­ã¾ã‚Œã¾ã™" class="w-full p-3 border rounded-lg">
                </div>

                <!-- ã‚«ãƒ†ã‚´ãƒª -->
                <div>
                    <label id="categoryLabel" class="text-xs font-bold text-gray-600 mb-1 block">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="categorySelect" class="w-full p-3 border rounded-lg bg-white"></select>
                </div>

                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <button onclick="saveCard()" id="saveCardBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold text-lg shadow-md active:scale-95 transition-all">
                    <i class="fas fa-save mr-2"></i>ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="exportModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center" onclick="if(event.target===this) closeExportModal()">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl m-4">
            <div class="bg-gradient-to-r from-green-600 to-green-500 p-4 text-white flex justify-between items-center">
                <span id="exportTitle" class="font-bold"><i class="fas fa-download mr-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
                <button onclick="closeExportModal()" class="w-8 h-8 hover:bg-white/20 rounded-full flex items-center justify-center transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <button onclick="exportCards('all')" id="exportAllBtn" class="w-full py-3 bg-green-50 border border-green-300 text-green-700 rounded-lg font-bold hover:bg-green-100 transition-colors">
                    <i class="fas fa-globe mr-2"></i>ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰
                </button>
                <button onclick="exportCards('pinned')" id="exportPinnedBtn" class="w-full py-3 bg-yellow-50 border border-yellow-300 text-yellow-700 rounded-lg font-bold hover:bg-yellow-100 transition-colors">
                    <i class="fas fa-star mr-2"></i>ãƒ”ãƒ³ç•™ã‚ã®ã¿
                </button>
                <div>
                    <select id="exportCategorySelect" class="w-full p-3 border rounded-lg bg-white mb-2"></select>
                    <button onclick="exportCards('category')" id="exportCategoryBtn" class="w-full py-3 bg-blue-50 border border-blue-300 text-blue-700 rounded-lg font-bold hover:bg-blue-100 transition-colors">
                        <i class="fas fa-folder mr-2"></i>é¸æŠã‚«ãƒ†ã‚´ãƒª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importFileInput" accept=".json" onchange="handleImport(this)" class="hidden">
    <div id="toastArea"></div>

    <script>
        const DB_KEY = 'pecsData_v3';
        let cards = [];
        let categories = [
            {id: 'require', name: 'å¿…è¦', nameChild: 'ã²ã¤ã‚ˆã†', emoji: 'â­', color: 'cat-require'},
            {id: 'life', name: 'ç”Ÿæ´»', nameChild: 'ã›ã„ã‹ã¤', emoji: 'ğŸ ', color: 'cat-life'},
            {id: 'food', name: 'é£Ÿäº‹', nameChild: 'ã—ã‚‡ãã˜', emoji: 'ğŸ', color: 'cat-food'},
            {id: 'play', name: 'éŠã³', nameChild: 'ã‚ãã³', emoji: 'âš½', color: 'cat-play'},
            {id: 'feeling', name: 'æ°—æŒã¡', nameChild: 'ãã‚‚ã¡', emoji: 'ğŸ˜Š', color: 'cat-feeling'},
            {id: 'color', name: 'è‰²', nameChild: 'ã„ã‚', emoji: 'ğŸ¨', color: 'cat-color'},
            {id: 'other', name: 'ãã®ä»–', nameChild: 'ãã®ãŸ', emoji: 'ğŸ“¦', color: 'cat-other'}
        ];
        
        let sentenceStrip = [];
        let currentFilter = 'all';
        let currentSort = 'default';
        let currentMode = 'adult';
        let currentGridSize = 'medium';
        let pinFilterActive = false;
        let isSpeaking = false;
        let currentImageType = 'emoji';
        let canvasData = null;

        // Canvasæç”»é–¢é€£
        let canvas, ctx, isDrawing = false;

        // çµµæ–‡å­—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const emojiDatabase = {
            smileys: ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜š','ğŸ˜™','ğŸ¥²','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–'],
            animals: ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ½','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸ','ğŸœ','ğŸ¦Ÿ','ğŸ¦—','ğŸ•·ï¸','ğŸ•¸ï¸','ğŸ¦‚','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦–','ğŸ¦•','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦','ğŸ¦€','ğŸ¡','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸŠ','ğŸ…','ğŸ†','ğŸ¦“','ğŸ¦','ğŸ¦§','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ¦™','ğŸ','ğŸ¦Œ','ğŸ•','ğŸ©','ğŸ¦®','ğŸ•â€ğŸ¦º','ğŸˆ','ğŸ“','ğŸ¦ƒ','ğŸ¦š','ğŸ¦œ','ğŸ¦¢','ğŸ¦©','ğŸ•Šï¸','ğŸ‡','ğŸ¦','ğŸ¦¨','ğŸ¦¡','ğŸ¦¦','ğŸ¦¥','ğŸ','ğŸ€','ğŸ¿ï¸','ğŸ¦”'],
            food: ['ğŸ','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶ï¸','ğŸŒ½','ğŸ¥•','ğŸ«‘','ğŸ¥—','ğŸ¥”','ğŸ ','ğŸ¥','ğŸ¥¯','ğŸ','ğŸ¥–','ğŸ¥¨','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸ¦´','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ«“','ğŸ¥ª','ğŸ¥™','ğŸ§†','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥—','ğŸ¥˜','ğŸ«•','ğŸ¥«','ğŸ','ğŸœ','ğŸ²','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¦ª','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥ ','ğŸ¥®','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸµ','ğŸ§ƒ','ğŸ¥¤','ğŸ§‹','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ§‰','ğŸ¾','ğŸ§Š'],
            activities: ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ‘','ğŸ¥','ğŸ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ£','ğŸ¤¿','ğŸ¥Š','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ‹ï¸','ğŸ¤¼','ğŸ¤¸','ğŸ¤º','ğŸ¤¾','ğŸŒï¸','ğŸ‡','ğŸ§˜','ğŸ„','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ§—','ğŸšµ','ğŸš´','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸','ğŸµï¸','ğŸ—ï¸','ğŸ«','ğŸŸï¸','ğŸª','ğŸ¤¹','ğŸ­','ğŸ©°','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸ¹','ğŸ¥','ğŸª˜','ğŸ·','ğŸº','ğŸª—','ğŸ¸','ğŸª•','ğŸ»','ğŸ²','â™Ÿï¸','ğŸ¯','ğŸ³','ğŸ®','ğŸ°','ğŸ§©'],
            travel: ['ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸï¸','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›','ğŸšœ','ğŸ¦¯','ğŸ¦½','ğŸ¦¼','ğŸ›´','ğŸš²','ğŸ›µ','ğŸï¸','ğŸ›º','ğŸš¨','ğŸš”','ğŸš','ğŸš˜','ğŸš–','ğŸš¡','ğŸš ','ğŸšŸ','ğŸšƒ','ğŸš‹','ğŸš','ğŸš','ğŸš„','ğŸš…','ğŸšˆ','ğŸš‚','ğŸš†','ğŸš‡','ğŸšŠ','ğŸš‰','âœˆï¸','ğŸ›«','ğŸ›¬','ğŸª‚','ğŸ’º','ğŸš','ğŸ›©ï¸','ğŸ›°ï¸','ğŸš€','ğŸ›¸','ğŸš¢','â›µ','ğŸ›¶','ğŸš¤','ğŸ›³ï¸','â›´ï¸','ğŸ›¥ï¸','ğŸš§','â›½','ğŸš','ğŸ—ºï¸','ğŸ—¿','ğŸ—½','ğŸ—¼','ğŸ°','ğŸ¯','ğŸŸï¸','ğŸ¡','ğŸ¢','ğŸ ','â›²','â›±ï¸','ğŸ–ï¸','ğŸï¸','ğŸœï¸','ğŸŒ‹','â›°ï¸','ğŸ”ï¸','ğŸ—»','ğŸ•ï¸','â›º','ğŸ›–','ğŸ ','ğŸ¡','ğŸ˜ï¸','ğŸšï¸','ğŸ—ï¸','ğŸ­','ğŸ¢','ğŸ¬','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸª','ğŸ«','ğŸ©','ğŸ’’','ğŸ›ï¸','â›ª','ğŸ•Œ','ğŸ•','ğŸ›•','ğŸ•‹'],
            objects: ['âŒš','ğŸ“±','ğŸ“²','ğŸ’»','âŒ¨ï¸','ğŸ–¥ï¸','ğŸ–¨ï¸','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ•¹ï¸','ğŸ—œï¸','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ“¼','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ¥','ğŸ“½ï¸','ğŸï¸','ğŸ“','â˜ï¸','ğŸ“Ÿ','ğŸ“ ','ğŸ“º','ğŸ“»','ğŸ™ï¸','ğŸšï¸','ğŸ›ï¸','ğŸ§­','â±ï¸','â²ï¸','â°','ğŸ•°ï¸','âŒ›','â³','ğŸ“¡','ğŸ”‹','ğŸ”Œ','ğŸ’¡','ğŸ”¦','ğŸ•¯ï¸','ğŸª”','ğŸ§¯','ğŸ›¢ï¸','ğŸ’¸','ğŸ’µ','ğŸ’´','ğŸ’¶','ğŸ’·','ğŸª™','ğŸ’°','ğŸ’³','ğŸ’','âš–ï¸','ğŸªœ','ğŸ§°','ğŸª›','ğŸ”§','ğŸ”¨','âš’ï¸','ğŸ› ï¸','â›ï¸','ğŸªš','ğŸ”©','âš™ï¸','ğŸª¤','ğŸ§±','â›“ï¸','ğŸ§²','ğŸ”«','ğŸ’£','ğŸ§¨','ğŸª“','ğŸ”ª','ğŸ—¡ï¸','âš”ï¸','ğŸ›¡ï¸','ğŸš¬','âš°ï¸','ğŸª¦','âš±ï¸','ğŸº','ğŸ”®','ğŸ“¿','ğŸ§¿','ğŸ’ˆ','âš—ï¸','ğŸ”­','ğŸ”¬','ğŸ•³ï¸','ğŸ©¹','ğŸ©º','ğŸ’Š','ğŸ’‰','ğŸ©¸','ğŸ§¬','ğŸ¦ ','ğŸ§«','ğŸ§ª','ğŸŒ¡ï¸','ğŸ§¹','ğŸª ','ğŸ§º','ğŸ§»','ğŸš½','ğŸš°','ğŸš¿','ğŸ›','ğŸ›€','ğŸ§¼','ğŸª’','ğŸ§½','ğŸ§´','ğŸ›ï¸','ğŸ”‘','ğŸ—ï¸','ğŸšª','ğŸª‘','ğŸ›‹ï¸','ğŸ›ï¸','ğŸ›Œ','ğŸ§¸','ğŸª†','ğŸ–¼ï¸','ğŸª','ğŸªŸ','ğŸ›ï¸','ğŸ','ğŸˆ','ğŸ','ğŸ€','ğŸª„','ğŸª…','ğŸŠ','ğŸ‰','ğŸ','ğŸ®','ğŸ','ğŸ§§','âœ‰ï¸','ğŸ“©','ğŸ“¨','ğŸ“§','ğŸ’Œ','ğŸ“¥','ğŸ“¤','ğŸ“¦','ğŸ·ï¸','ğŸª§','ğŸ“ª','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ“¯','ğŸ“œ','ğŸ“ƒ','ğŸ“„','ğŸ“‘','ğŸ§¾','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ—’ï¸','ğŸ—“ï¸','ğŸ“†','ğŸ“…','ğŸ—‘ï¸','ğŸ“‡','ğŸ—ƒï¸','ğŸ—³ï¸','ğŸ—„ï¸','ğŸ“‹','ğŸ“','ğŸ“‚','ğŸ—‚ï¸','ğŸ—ï¸','ğŸ“°','ğŸ““','ğŸ“”','ğŸ“’','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“š','ğŸ“–','ğŸ”–','ğŸ§·','ğŸ”—','ğŸ“','ğŸ–‡ï¸','ğŸ“','ğŸ“','ğŸ§®','ğŸ“Œ','ğŸ“','âœ‚ï¸','ğŸ–Šï¸','ğŸ–‹ï¸','âœ’ï¸','ğŸ–Œï¸','ğŸ–ï¸','ğŸ“','âœï¸','ğŸ”','ğŸ”','ğŸ”','ğŸ”','ğŸ”’','ğŸ”“'],
            symbols: ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ†”','âš›ï¸','ğŸ‰‘','â˜¢ï¸','â˜£ï¸','ğŸ“´','ğŸ“³','ğŸˆ¶','ğŸˆš','ğŸˆ¸','ğŸˆº','ğŸˆ·ï¸','âœ´ï¸','ğŸ†š','ğŸ’®','ğŸ‰','ãŠ™ï¸','ãŠ—ï¸','ğŸˆ´','ğŸˆµ','ğŸˆ¹','ğŸˆ²','ğŸ…°ï¸','ğŸ…±ï¸','ğŸ†','ğŸ†‘','ğŸ…¾ï¸','ğŸ†˜','âŒ','â­•','ğŸ›‘','â›”','ğŸ“›','ğŸš«','ğŸ’¯','ğŸ’¢','â™¨ï¸','ğŸš·','ğŸš¯','ğŸš³','ğŸš±','ğŸ”','ğŸ“µ','ğŸš­','â—','â•','â“','â”','â€¼ï¸','â‰ï¸','ğŸ”…','ğŸ”†','ã€½ï¸','âš ï¸','ğŸš¸','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','ğŸˆ¯','ğŸ’¹','â‡ï¸','âœ³ï¸','â','ğŸŒ','ğŸ’ ','â“‚ï¸','ğŸŒ€','ğŸ’¤','ğŸ§','ğŸš¾','â™¿','ğŸ…¿ï¸','ğŸ›—','ğŸˆ³','ğŸˆ‚ï¸','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','ğŸš¹','ğŸšº','ğŸš¼','âš§ï¸','ğŸš»','ğŸš®','ğŸ¦','ğŸ“¶','ğŸˆ','ğŸ”£','â„¹ï¸','ğŸ”¤','ğŸ”¡','ğŸ” ','ğŸ†–','ğŸ†—','ğŸ†™','ğŸ†’','ğŸ†•','ğŸ†“','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ','ğŸ”¢','#ï¸âƒ£','*ï¸âƒ£','âï¸','â–¶ï¸','â¸ï¸','â¯ï¸','â¹ï¸','âºï¸','â­ï¸','â®ï¸','â©','âª','â«','â¬','â—€ï¸','ğŸ”¼','ğŸ”½','â¡ï¸','â¬…ï¸','â¬†ï¸','â¬‡ï¸','â†—ï¸','â†˜ï¸','â†™ï¸','â†–ï¸','â†•ï¸','â†”ï¸','â†ªï¸','â†©ï¸','â¤´ï¸','â¤µï¸','ğŸ”€','ğŸ”','ğŸ”‚','ğŸ”„','ğŸ”ƒ','ğŸµ','ğŸ¶','â•','â–','â—','âœ–ï¸','â™¾ï¸','ğŸ’²','ğŸ’±','â„¢ï¸','Â©ï¸','Â®ï¸','ã€°ï¸','â°','â¿','ğŸ”š','ğŸ”™','ğŸ”›','ğŸ”','ğŸ”œ','âœ”ï¸','â˜‘ï¸','ğŸ”˜','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âš«','âšª','ğŸŸ¤','ğŸ”º','ğŸ”»','ğŸ”¸','ğŸ”¹','ğŸ”¶','ğŸ”·','ğŸ”³','ğŸ”²','â–ªï¸','â–«ï¸','â—¾','â—½','â—¼ï¸','â—»ï¸','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','â¬›','â¬œ','ğŸŸ«','ğŸ”ˆ','ğŸ”‡','ğŸ”‰','ğŸ”Š','ğŸ””','ğŸ”•','ğŸ“£','ğŸ“¢','ğŸ’¬','ğŸ’­','ğŸ—¯ï¸','â™ ï¸','â™£ï¸','â™¥ï¸','â™¦ï¸','ğŸƒ','ğŸ´','ğŸ€„','ğŸ•','ğŸ•‘','ğŸ•’','ğŸ•“','ğŸ•”','ğŸ••','ğŸ•–','ğŸ•—','ğŸ•˜','ğŸ•™','ğŸ•š','ğŸ•›','ğŸ•œ','ğŸ•','ğŸ•','ğŸ•Ÿ','ğŸ• ','ğŸ•¡','ğŸ•¢','ğŸ•£','ğŸ•¤','ğŸ•¥','ğŸ•¦','ğŸ•§']
        };

        let currentEmojiCategory = 'smileys';

        function initCanvas() {
            canvas = document.getElementById('drawCanvas');
            ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseleave', stopDraw);

            canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e.touches[0]); });
            canvas.addEventListener('touchmove', e => { e.preventDefault(); draw(e.touches[0]); });
            canvas.addEventListener('touchend', stopDraw);
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            ctx.strokeStyle = document.getElementById('drawColor').value;
            ctx.lineWidth = document.getElementById('drawWidth').value;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function showEmojiCategory(category) {
            currentEmojiCategory = category;
            const grid = document.getElementById('emojiGrid');
            const emojis = emojiDatabase[category] || [];
            
            grid.innerHTML = emojis.map(emoji => 
                `<button type="button" onclick="setEmoji('${emoji}')" class="text-2xl p-2 hover:bg-gray-100 rounded transition-colors">${emoji}</button>`
            ).join('');

            // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.emoji-cat-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100');
            });
            event.target.classList.add('bg-blue-100');
        }

        // åˆæœŸåŒ–
        function init() {
            initCanvas();
            loadData();
            addDefaultCards();
            updateModeUI();
            renderCategoryBar();
            renderCards();
            updateSortUI();
            updateGridSizeUI();
            showEmojiCategory('smileys'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çµµæ–‡å­—ã‚«ãƒ†ã‚´ãƒªã‚’è¡¨ç¤º
        }

        function loadData() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                const data = JSON.parse(saved);
                cards = data.cards || [];
                if(data.categories) categories = data.categories;
                currentMode = data.mode || 'adult';
                currentGridSize = data.gridSize || 'medium';
                currentSort = data.sort || 'default';
            }
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify({
                cards, categories, mode: currentMode, gridSize: currentGridSize, sort: currentSort
            }));
        }

        function addDefaultCards() {
            if(cards.length > 0) return;

            const defaults = [
                // å¿…è¦ã‚«ãƒ†ã‚´ãƒª
                {kanji: 'ãƒˆã‚¤ãƒ¬', hiragana: 'ã¨ã„ã‚Œ', talk: 'ãƒˆã‚¤ãƒ¬ã«è¡ŒããŸã„ã§ã™', emoji: 'ğŸš½', category: 'require'},
                {kanji: 'é£²ã‚€', hiragana: 'ã®ã‚€', talk: 'é£²ã¿ç‰©ãŒæ¬²ã—ã„ã§ã™', emoji: 'ğŸ’§', category: 'require'},
                {kanji: 'ä¼‘ã‚€', hiragana: 'ã‚„ã™ã‚€', talk: 'ä¼‘ã¿ãŸã„ã§ã™', emoji: 'ğŸ˜´', category: 'require'},
                {kanji: 'åŠ©ã‘ã¦', hiragana: 'ãŸã™ã‘ã¦', talk: 'åŠ©ã‘ã¦ãã ã•ã„', emoji: 'ğŸ†˜', category: 'require'},
                
                // ç”Ÿæ´»ã‚«ãƒ†ã‚´ãƒª
                {kanji: 'ãŠã¯ã‚ˆã†', hiragana: 'ãŠã¯ã‚ˆã†', talk: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™', emoji: 'ğŸŒ…', category: 'life'},
                {kanji: 'ãŠã‚„ã™ã¿', hiragana: 'ãŠã‚„ã™ã¿', talk: 'ãŠã‚„ã™ã¿ãªã•ã„', emoji: 'ğŸŒ™', category: 'life'},
                {kanji: 'ã‚ã‚ŠãŒã¨ã†', hiragana: 'ã‚ã‚ŠãŒã¨ã†', talk: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™', emoji: 'ğŸ™', category: 'life'},
                
                // é£Ÿäº‹ã‚«ãƒ†ã‚´ãƒª
                {kanji: 'ã”ã¯ã‚“', hiragana: 'ã”ã¯ã‚“', talk: 'ã”ã¯ã‚“ã‚’é£Ÿã¹ãŸã„ã§ã™', emoji: 'ğŸš', category: 'food'},
                {kanji: 'ãŠã‚„ã¤', hiragana: 'ãŠã‚„ã¤', talk: 'ãŠã‚„ã¤ãŒæ¬²ã—ã„ã§ã™', emoji: 'ğŸ°', category: 'food'},
                {kanji: 'ã‚Šã‚“ã”', hiragana: 'ã‚Šã‚“ã”', talk: 'ã‚Šã‚“ã”ã‚’é£Ÿã¹ãŸã„ã§ã™', emoji: 'ğŸ', category: 'food'},
                {kanji: 'ãƒãƒŠãƒŠ', hiragana: 'ã°ãªãª', talk: 'ãƒãƒŠãƒŠã‚’é£Ÿã¹ãŸã„ã§ã™', emoji: 'ğŸŒ', category: 'food'},
                {kanji: 'ãƒ‘ãƒ³', hiragana: 'ã±ã‚“', talk: 'ãƒ‘ãƒ³ã‚’é£Ÿã¹ãŸã„ã§ã™', emoji: 'ğŸ', category: 'food'},
                
                // éŠã³ã‚«ãƒ†ã‚´ãƒª
                {kanji: 'ã‚ãã¶', hiragana: 'ã‚ãã¶', talk: 'éŠã³ãŸã„ã§ã™', emoji: 'âš½', category: 'play'},
                {kanji: 'ãƒ†ãƒ¬ãƒ“', hiragana: 'ã¦ã‚Œã³', talk: 'ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ãŸã„ã§ã™', emoji: 'ğŸ“º', category: 'play'},
                {kanji: 'æœ¬', hiragana: 'ã»ã‚“', talk: 'æœ¬ã‚’èª­ã¿ãŸã„ã§ã™', emoji: 'ğŸ“š', category: 'play'},
                {kanji: 'å…¬åœ’', hiragana: 'ã“ã†ãˆã‚“', talk: 'å…¬åœ’ã«è¡ŒããŸã„ã§ã™', emoji: 'ğŸï¸', category: 'play'},
                {kanji: 'ãŠåº—', hiragana: 'ãŠã¿ã›', talk: 'ãŠåº—ã«è¡ŒããŸã„ã§ã™', emoji: 'ğŸª', category: 'play'},
                
                // æ°—æŒã¡ã‚«ãƒ†ã‚´ãƒª
                {kanji: 'ã†ã‚Œã—ã„', hiragana: 'ã†ã‚Œã—ã„', talk: 'ã†ã‚Œã—ã„ã§ã™', emoji: 'ğŸ˜Š', category: 'feeling'},
                {kanji: 'ã‹ãªã—ã„', hiragana: 'ã‹ãªã—ã„', talk: 'æ‚²ã—ã„ã§ã™', emoji: 'ğŸ˜¢', category: 'feeling'},
                {kanji: 'æ€’ã£ãŸ', hiragana: 'ãŠã“ã£ãŸ', talk: 'æ€’ã£ã¦ã„ã¾ã™', emoji: 'ğŸ˜ ', category: 'feeling'},
                {kanji: 'ã“ã‚ã„', hiragana: 'ã“ã‚ã„', talk: 'æ€–ã„ã§ã™', emoji: 'ğŸ˜¨', category: 'feeling'},
                
                // è‰²ã‚«ãƒ†ã‚´ãƒªï¼ˆå……å®ŸåŒ–ï¼‰
                {kanji: 'èµ¤ã„', hiragana: 'ã‚ã‹ã„', talk: 'èµ¤ã„', emoji: 'ğŸ”´', category: 'color'},
                {kanji: 'é’ã„', hiragana: 'ã‚ãŠã„', talk: 'é’ã„', emoji: 'ğŸ”µ', category: 'color'},
                {kanji: 'é»„è‰²ã„', hiragana: 'ãã„ã‚ã„', talk: 'é»„è‰²ã„', emoji: 'ğŸŸ¡', category: 'color'},
                {kanji: 'ç·‘', hiragana: 'ã¿ã©ã‚Š', talk: 'ç·‘', emoji: 'ğŸŸ¢', category: 'color'},
                {kanji: 'ç™½ã„', hiragana: 'ã—ã‚ã„', talk: 'ç™½ã„', emoji: 'âšª', category: 'color'},
                {kanji: 'é»’ã„', hiragana: 'ãã‚ã„', talk: 'é»’ã„', emoji: 'âš«', category: 'color'},
                {kanji: 'ãƒ”ãƒ³ã‚¯', hiragana: 'ã´ã‚“ã', talk: 'ãƒ”ãƒ³ã‚¯', emoji: 'ğŸ©·', category: 'color'},
                {kanji: 'ã‚ªãƒ¬ãƒ³ã‚¸', hiragana: 'ãŠã‚Œã‚“ã˜', talk: 'ã‚ªãƒ¬ãƒ³ã‚¸', emoji: 'ğŸŸ ', category: 'color'},
                {kanji: 'ç´«', hiragana: 'ã‚€ã‚‰ã•ã', talk: 'ç´«', emoji: 'ğŸŸ£', category: 'color'},
                {kanji: 'èŒ¶è‰²', hiragana: 'ã¡ã‚ƒã„ã‚', talk: 'èŒ¶è‰²', emoji: 'ğŸŸ¤', category: 'color'},
            ];

            defaults.forEach(d => {
                cards.push({
                    id: 'def_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    ...d,
                    imageType: 'emoji',
                    pinned: false,
                    usageCount: 0,
                    timestamp: Date.now()
                });
            });
            saveData();
        }

        // UIæ›´æ–°
        function updateModeUI() {
            const isChild = currentMode === 'child';
            document.getElementById('modeBadge').textContent = isChild ? 'ã²ã‚‰ãŒãª' : 'æ¼¢å­—';
            
            // UIå…¨ä½“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('stripPlaceholderText').textContent = isChild ? 'ã‹ãƒ¼ã©ã‚’ãªã‚‰ã¹ã¦ã­' : 'ã‚«ãƒ¼ãƒ‰ã‚’ãªã‚‰ã¹ã¦ã­';
            document.getElementById('emptyText').textContent = isChild ? 'ã‹ãƒ¼ã©ãŒã‚ã‚Šã¾ã›ã‚“' : 'ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“';
            document.getElementById('settingsTitle').innerHTML = isChild ? '<i class="fas fa-cog mr-2"></i>ã›ã£ã¦ã„' : '<i class="fas fa-cog mr-2"></i>è¨­å®š';
            document.getElementById('modeLabel').textContent = isChild ? 'ã²ã‚‡ã†ã˜ã‚‚ãƒ¼ã©' : 'è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰';
            document.getElementById('sizeLabel').textContent = isChild ? 'ã‹ãƒ¼ã©ã•ã„ãš' : 'ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚º';
            document.getElementById('sortLabel').textContent = isChild ? 'ãªã‚‰ã³ã˜ã‚…ã‚“' : 'ä¸¦ã³é †';
            document.getElementById('dataLabel').textContent = isChild ? 'ã§ãƒ¼ãŸã‹ã‚“ã‚Š' : 'ãƒ‡ãƒ¼ã‚¿ç®¡ç†';
            document.getElementById('exportBtn').innerHTML = isChild ? '<i class="fas fa-download mr-1"></i>ã ã™' : '<i class="fas fa-download mr-1"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
            document.getElementById('importBtn').innerHTML = isChild ? '<i class="fas fa-upload mr-1"></i>ã„ã‚Œã‚‹' : '<i class="fas fa-upload mr-1"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
            document.getElementById('resetBtn').innerHTML = isChild ? '<i class="fas fa-trash mr-1"></i>ã‚Šã›ã£ã¨' : '<i class="fas fa-trash mr-1"></i>ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–';
            document.getElementById('addCardBtn').innerHTML = isChild ? '<i class="fas fa-plus"></i> <span class="hidden sm:inline">ã¤ãã‚‹</span>' : '<i class="fas fa-plus"></i> <span class="hidden sm:inline">ä½œã‚‹</span>';
            document.getElementById('playBtnText').textContent = 'ãŠã¯ãªã—';
            document.getElementById('popBtn').querySelector('span').textContent = isChild ? '1ã¤ã‘ã™' : '1ã¤æ¶ˆã™';
            document.getElementById('clearBtn').querySelector('span').textContent = isChild ? 'ãœã‚“ã‘ã—' : 'å…¨æ¶ˆã—';
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ†ã‚­ã‚¹ãƒˆ
            document.getElementById('modalTitle').innerHTML = isChild ? '<i class="fas fa-plus-circle mr-2"></i>ã‹ãƒ¼ã©ã‚’ã¤ãã‚‹' : '<i class="fas fa-plus-circle mr-2"></i>ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹';
            document.getElementById('imageLabel').textContent = isChild ? 'ãˆãƒ»ãŒãã†' : 'çµµãƒ»ç”»åƒ';
            document.getElementById('emojiText').textContent = isChild ? 'ãˆã‚‚ã˜' : 'çµµæ–‡å­—';
            document.getElementById('fileText').textContent = isChild ? 'ã—ã‚ƒã—ã‚“' : 'å†™çœŸ';
            document.getElementById('canvasText').textContent = isChild ? 'ã‹ã' : 'æã';
            document.getElementById('kanjiLabel').textContent = isChild ? 'ã‹ã‚“ã˜' : 'æ¼¢å­—';
            document.getElementById('hiraganaLabel').textContent = isChild ? 'ã²ã‚‰ãŒãª' : 'ã²ã‚‰ãŒãª';
            document.getElementById('talkLabel').textContent = isChild ? 'ã‚ˆã¿ã‚ã’ï¼ˆã—ã‚‡ã†ã‚Šã‚ƒãã‹ï¼‰' : 'èª­ã¿ä¸Šã’ï¼ˆçœç•¥å¯ï¼‰';
            document.getElementById('categoryLabel').textContent = isChild ? 'ã‹ã¦ã”ã‚Š' : 'ã‚«ãƒ†ã‚´ãƒª';
            document.getElementById('saveCardBtn').innerHTML = isChild ? '<i class="fas fa-save mr-2"></i>ã»ãã‚“' : '<i class="fas fa-save mr-2"></i>ä¿å­˜';
            
            // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('exportTitle').innerHTML = isChild ? '<i class="fas fa-download mr-2"></i>ã ã™' : '<i class="fas fa-download mr-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
            document.getElementById('exportAllBtn').innerHTML = isChild ? '<i class="fas fa-globe mr-2"></i>ãœã‚“ã¶ã®ã‹ãƒ¼ã©' : '<i class="fas fa-globe mr-2"></i>ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰';
            document.getElementById('exportPinnedBtn').innerHTML = isChild ? '<i class="fas fa-star mr-2"></i>ã´ã‚“ã©ã‚ã®ã¿' : '<i class="fas fa-star mr-2"></i>ãƒ”ãƒ³ç•™ã‚ã®ã¿';
            document.getElementById('exportCategoryBtn').innerHTML = isChild ? '<i class="fas fa-folder mr-2"></i>ã›ã‚“ãŸãã‹ã¦ã”ã‚Š' : '<i class="fas fa-folder mr-2"></i>é¸æŠã‚«ãƒ†ã‚´ãƒª';

            // Buy Me a Coffeeãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            const coffeeSection = document.getElementById('coffeeSection');
            if(isChild) {
                coffeeSection.classList.add('hidden');
            } else {
                coffeeSection.classList.remove('hidden');
            }

            const childBtn = document.getElementById('modeChildBtn');
            const adultBtn = document.getElementById('modeAdultBtn');
            if(isChild) {
                childBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                childBtn.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
                adultBtn.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
                adultBtn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
            } else {
                adultBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                adultBtn.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
                childBtn.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
                childBtn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
            }
        }

        function renderCategoryBar() {
            const bar = document.getElementById('categoryBar');
            const isChild = currentMode === 'child';
            bar.innerHTML = `
                <button onclick="setFilter('all')" id="catAll" class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all">
                    ${isChild ? 'ã™ã¹ã¦' : 'ã™ã¹ã¦'}
                </button>
            ` + categories.map(c => `
                <button onclick="setFilter('${c.id}')" id="cat${c.id}" class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all">
                    ${c.emoji} ${isChild ? c.nameChild : c.name}
                </button>
            `).join('');
            updateCategoryUI();
        }

        function updateCategoryUI() {
            document.querySelectorAll('#categoryBar button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'shadow-md');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            const activeBtn = document.getElementById(currentFilter === 'all' ? 'catAll' : 'cat' + currentFilter);
            if(activeBtn) {
                activeBtn.classList.add('bg-blue-500', 'text-white', 'shadow-md');
                activeBtn.classList.remove('bg-white', 'text-gray-600');
            }
        }

        function renderCards() {
            let filtered = currentFilter === 'all' ? [...cards] : cards.filter(c => c.category === currentFilter);
            if(pinFilterActive) filtered = filtered.filter(c => c.pinned);
            
            // ã‚½ãƒ¼ãƒˆ
            switch(currentSort) {
                case 'name-asc':
                    filtered.sort((a, b) => a.kanji.localeCompare(b.kanji, 'ja'));
                    break;
                case 'name-desc':
                    filtered.sort((a, b) => b.kanji.localeCompare(a.kanji, 'ja'));
                    break;
                case 'category':
                    filtered.sort((a, b) => {
                        const catA = categories.findIndex(c => c.id === a.category);
                        const catB = categories.findIndex(c => c.id === b.category);
                        return catA - catB;
                    });
                    break;
                case 'usage':
                    filtered.sort((a, b) => (b.usageCount || 0) - (a.usageCount || 0));
                    break;
                default: // default
                    filtered.sort((a, b) => {
                        if(a.pinned && !b.pinned) return -1;
                        if(!a.pinned && b.pinned) return 1;
                        return b.timestamp - a.timestamp;
                    });
            }

            const grid = document.getElementById('cardGrid');
            const empty = document.getElementById('emptyState');

            if(filtered.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                empty.classList.add('flex');
            } else {
                empty.classList.add('hidden');
                empty.classList.remove('flex');
                grid.innerHTML = filtered.map(c => renderCard(c)).join('');
            }
        }

        function renderCard(card) {
            const cat = categories.find(ct => ct.id === card.category) || categories[categories.length - 1];
            const displayText = currentMode === 'child' ? card.hiragana : card.kanji;
            
            let imageHtml = '';
            if(card.imageType === 'emoji') {
                imageHtml = `<div class="text-5xl mb-2">${card.emoji || 'ğŸ“„'}</div>`;
            } else if(card.imageType === 'file' && card.imageData) {
                imageHtml = `<img src="${card.imageData}" class="w-full h-20 object-contain mb-2">`;
            } else if(card.imageType === 'canvas' && card.canvasData) {
                imageHtml = `<img src="${card.canvasData}" class="w-full h-20 object-contain mb-2">`;
            }

            return `
                <div class="pecs-card ${cat.color} rounded-xl p-3 flex flex-col items-center justify-center aspect-square relative" onclick="addToStrip('${card.id}')">
                    ${card.pinned ? '<i class="fas fa-thumbtack pin-badge"></i>' : ''}
                    ${imageHtml}
                    <span class="font-bold text-center text-sm leading-tight">${displayText}</span>
                    <div class="absolute bottom-1 right-1 flex gap-1">
                        <button onclick="event.stopPropagation(); togglePin('${card.id}')" class="w-6 h-6 bg-white/80 hover:bg-white rounded-full flex items-center justify-center shadow-sm">
                            <i class="fas fa-thumbtack text-xs ${card.pinned ? 'text-yellow-500' : 'text-gray-400'}"></i>
                        </button>
                        <button onclick="event.stopPropagation(); editCard('${card.id}')" class="w-6 h-6 bg-white/80 hover:bg-white rounded-full flex items-center justify-center shadow-sm">
                            <i class="fas fa-edit text-xs text-blue-600"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteCard('${card.id}')" class="w-6 h-6 bg-white/80 hover:bg-white rounded-full flex items-center justify-center shadow-sm">
                            <i class="fas fa-trash text-xs text-red-600"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSentenceStrip() {
            const strip = document.getElementById('sentenceStrip');
            const placeholder = document.getElementById('stripPlaceholder');
            
            if(sentenceStrip.length === 0) {
                if(!placeholder) {
                    strip.innerHTML = `<div id="stripPlaceholder" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 font-bold">
                        <i class="fas fa-hand-pointer mr-2"></i> <span id="stripPlaceholderText">${currentMode === 'child' ? 'ã‹ãƒ¼ã©ã‚’ãªã‚‰ã¹ã¦ã­' : 'ã‚«ãƒ¼ãƒ‰ã‚’ãªã‚‰ã¹ã¦ã­'}</span>
                    </div>`;
                } else {
                    placeholder.classList.remove('hidden');
                }
            } else {
                if(placeholder) placeholder.classList.add('hidden');
                
                const cardsHtml = sentenceStrip.map((c, i) => {
                    const displayText = currentMode === 'child' ? c.hiragana : c.kanji;
                    let imageHtml = '';
                    if(c.imageType === 'emoji') {
                        imageHtml = `<div class="text-3xl mb-1">${c.emoji || 'ğŸ“„'}</div>`;
                    } else if(c.imageType === 'file' && c.imageData) {
                        imageHtml = `<img src="${c.imageData}" class="w-full h-12 object-contain mb-1">`;
                    } else if(c.imageType === 'canvas' && c.canvasData) {
                        imageHtml = `<img src="${c.canvasData}" class="w-full h-12 object-contain mb-1">`;
                    }
                    
                    return `
                        <div id="strip-${i}" onclick="removeFromStrip(${i})" class="strip-card flex-none w-24 h-24 bg-white rounded-lg shadow-md p-2 flex flex-col items-center justify-center border-2 border-gray-200 transition-all">
                            ${imageHtml}
                            <span class="text-xs font-bold text-center leading-tight">${displayText}</span>
                        </div>
                    `;
                }).join('');
                
                strip.innerHTML = (placeholder ? '' : '') + cardsHtml;
            }
        }

        function addToStrip(cardId) {
            const card = cards.find(c => c.id === cardId);
            if(!card) return;
            
            card.usageCount = (card.usageCount || 0) + 1;
            sentenceStrip.push(card);
            saveData();
            renderSentenceStrip();
        }

        function removeFromStrip(index) {
            sentenceStrip.splice(index, 1);
            renderSentenceStrip();
        }

        function popLast() {
            if(sentenceStrip.length === 0) return;
            sentenceStrip.pop();
            renderSentenceStrip();
        }

        function clearAll() {
            if(sentenceStrip.length === 0) return;
            const isChild = currentMode === 'child';
            if(!confirm(isChild ? 'ãœã‚“ã¶ã‘ã™ã®ï¼Ÿ' : 'ã™ã¹ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) return;
            sentenceStrip = [];
            renderSentenceStrip();
        }

        function togglePin(cardId) {
            const card = cards.find(c => c.id === cardId);
            if(!card) return;
            card.pinned = !card.pinned;
            saveData();
            renderCards();
            showToast(card.pinned ? 'ğŸ“Œ ãƒ”ãƒ³ç•™ã‚ã—ã¾ã—ãŸ' : 'ğŸ“Œ ãƒ”ãƒ³ç•™ã‚è§£é™¤ã—ã¾ã—ãŸ');
        }

        function togglePinFilter() {
            pinFilterActive = !pinFilterActive;
            const btn = document.getElementById('pinFilterBtn');
            if(pinFilterActive) {
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-yellow-500');
            } else {
                btn.classList.add('text-gray-400');
                btn.classList.remove('text-yellow-500');
            }
            renderCards();
        }

        function setFilter(filter) {
            currentFilter = filter;
            updateCategoryUI();
            renderCards();
        }

        function setMode(mode) {
            currentMode = mode;
            saveData();
            updateModeUI();
            renderCategoryBar();
            renderCards();
            renderSentenceStrip();
        }

        function setGridSize(size) {
            currentGridSize = size;
            saveData();
            updateGridSizeUI();
        }

        function updateGridSizeUI() {
            const container = document.getElementById('mainContainer');
            container.className = container.className.replace(/grid-\w+-?\w*/g, '');
            container.classList.add('grid-' + currentGridSize);
            
            ['x-small', 'small', 'medium', 'large', 'x-large'].forEach(s => {
                const btn = document.getElementById('size' + s.split('-').map((w, i) => i === 0 ? w.toUpperCase() : w.charAt(0).toUpperCase() + w.slice(1)).join(''));
                if(s === currentGridSize) {
                    btn.classList.add('bg-blue-500', 'text-white');
                    btn.classList.remove('bg-white', 'text-gray-600');
                } else {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-600');
                }
            });
        }

        function setSort(sort) {
            currentSort = sort;
            saveData();
            renderCards();
        }

        function updateSortUI() {
            document.getElementById('sortSelect').value = currentSort;
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        // ã‚«ãƒ¼ãƒ‰ä½œæˆ/ç·¨é›†
        function openCardModal() {
            document.getElementById('editCardId').value = '';
            document.getElementById('kanjiInput').value = '';
            document.getElementById('hiraganaInput').value = '';
            document.getElementById('talkInput').value = '';
            document.getElementById('emojiInput').value = 'ğŸ˜Š';
            document.getElementById('categorySelect').innerHTML = categories.map(c => 
                `<option value="${c.id}">${c.emoji} ${currentMode === 'child' ? c.nameChild : c.name}</option>`
            ).join('');
            
            selectImageType('emoji');
            clearCanvas();
            document.getElementById('imageFileInput').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            
            document.getElementById('cardModal').classList.remove('hidden');
        }

        function closeCardModal() {
            document.getElementById('cardModal').classList.add('hidden');
        }

        function selectImageType(type) {
            currentImageType = type;
            
            document.getElementById('emojiPicker').classList.add('hidden');
            document.getElementById('filePicker').classList.add('hidden');
            document.getElementById('canvasPicker').classList.add('hidden');
            
            ['imageTypeEmoji', 'imageTypeFile', 'imageTypeCanvas'].forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
            });
            
            if(type === 'emoji') {
                document.getElementById('emojiPicker').classList.remove('hidden');
                document.getElementById('imageTypeEmoji').classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            } else if(type === 'file') {
                document.getElementById('filePicker').classList.remove('hidden');
                document.getElementById('imageTypeFile').classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            } else if(type === 'canvas') {
                document.getElementById('canvasPicker').classList.remove('hidden');
                document.getElementById('imageTypeCanvas').classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            }
        }

        function setEmoji(emoji) {
            document.getElementById('emojiInput').value = emoji;
        }

        function handleImageFile(input) {
            if(!input.files || !input.files[0]) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }

        function autoConvertToHiragana(text) {
            const conversionMap = {
                'ãƒˆã‚¤ãƒ¬': 'ã¨ã„ã‚Œ', 'é£²ã‚€': 'ã®ã‚€', 'ä¼‘ã‚€': 'ã‚„ã™ã‚€', 'åŠ©ã‘ã¦': 'ãŸã™ã‘ã¦',
                'ãŠã¯ã‚ˆã†': 'ãŠã¯ã‚ˆã†', 'ãŠã‚„ã™ã¿': 'ãŠã‚„ã™ã¿', 'ã‚ã‚ŠãŒã¨ã†': 'ã‚ã‚ŠãŒã¨ã†',
                'ã”ã¯ã‚“': 'ã”ã¯ã‚“', 'ãŠã‚„ã¤': 'ãŠã‚„ã¤', 'ã‚Šã‚“ã”': 'ã‚Šã‚“ã”', 'ãƒãƒŠãƒŠ': 'ã°ãªãª', 'ãƒ‘ãƒ³': 'ã±ã‚“',
                'ã‚ãã¶': 'ã‚ãã¶', 'ãƒ†ãƒ¬ãƒ“': 'ã¦ã‚Œã³', 'æœ¬': 'ã»ã‚“', 'å…¬åœ’': 'ã“ã†ãˆã‚“', 'ãŠåº—': 'ãŠã¿ã›',
                'ã†ã‚Œã—ã„': 'ã†ã‚Œã—ã„', 'ã‹ãªã—ã„': 'ã‹ãªã—ã„', 'æ€’ã£ãŸ': 'ãŠã“ã£ãŸ', 'ã“ã‚ã„': 'ã“ã‚ã„',
                'èµ¤ã„': 'ã‚ã‹ã„', 'é’ã„': 'ã‚ãŠã„', 'é»„è‰²ã„': 'ãã„ã‚ã„', 'ç·‘': 'ã¿ã©ã‚Š', 'ç™½ã„': 'ã—ã‚ã„',
                'é»’ã„': 'ãã‚ã„', 'ãƒ”ãƒ³ã‚¯': 'ã´ã‚“ã', 'ã‚ªãƒ¬ãƒ³ã‚¸': 'ãŠã‚Œã‚“ã˜', 'ç´«': 'ã‚€ã‚‰ã•ã', 'èŒ¶è‰²': 'ã¡ã‚ƒã„ã‚'
            };
            
            if(conversionMap[text]) {
                document.getElementById('hiraganaInput').value = conversionMap[text];
            }
        }

        function saveCard() {
            const kanji = document.getElementById('kanjiInput').value.trim();
            const hiragana = document.getElementById('hiraganaInput').value.trim();
            const talk = document.getElementById('talkInput').value.trim();
            const category = document.getElementById('categorySelect').value;
            
            if(!kanji || !hiragana) {
                alert(currentMode === 'child' ? 'ã‹ã‚“ã˜ã¨ã²ã‚‰ãŒãªã‚’ã„ã‚Œã¦ã­' : 'æ¼¢å­—ã¨ã²ã‚‰ãŒãªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            let imageData = null;
            let emoji = null;

            if(currentImageType === 'emoji') {
                emoji = document.getElementById('emojiInput').value;
            } else if(currentImageType === 'file') {
                const img = document.getElementById('previewImg').src;
                if(img && img.startsWith('data:')) {
                    imageData = img;
                }
            } else if(currentImageType === 'canvas') {
                imageData = canvas.toDataURL();
            }

            const editId = document.getElementById('editCardId').value;
            
            if(editId) {
                const card = cards.find(c => c.id === editId);
                if(card) {
                    card.kanji = kanji;
                    card.hiragana = hiragana;
                    card.talk = talk || kanji;
                    card.category = category;
                    card.imageType = currentImageType;
                    if(currentImageType === 'emoji') card.emoji = emoji;
                    else if(currentImageType === 'file') card.imageData = imageData;
                    else if(currentImageType === 'canvas') card.canvasData = imageData;
                    
                    showToast('âœï¸ ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†ã—ã¾ã—ãŸ');
                }
            } else {
                const newCard = {
                    id: 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    kanji, hiragana,
                    talk: talk || kanji,
                    category,
                    imageType: currentImageType,
                    pinned: false,
                    usageCount: 0,
                    timestamp: Date.now()
                };
                
                if(currentImageType === 'emoji') newCard.emoji = emoji;
                else if(currentImageType === 'file') newCard.imageData = imageData;
                else if(currentImageType === 'canvas') newCard.canvasData = imageData;
                
                cards.push(newCard);
                showToast('âœ¨ ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸ');
            }

            saveData();
            renderCards();
            closeCardModal();
        }

        function editCard(cardId) {
            const card = cards.find(c => c.id === cardId);
            if(!card) return;

            document.getElementById('editCardId').value = card.id;
            document.getElementById('kanjiInput').value = card.kanji;
            document.getElementById('hiraganaInput').value = card.hiragana;
            document.getElementById('talkInput').value = card.talk !== card.kanji ? card.talk : '';
            document.getElementById('categorySelect').innerHTML = categories.map(c => 
                `<option value="${c.id}" ${c.id === card.category ? 'selected' : ''}>${c.emoji} ${currentMode === 'child' ? c.nameChild : c.name}</option>`
            ).join('');

            selectImageType(card.imageType || 'emoji');
            
            if(card.imageType === 'emoji') {
                document.getElementById('emojiInput').value = card.emoji || 'ğŸ˜Š';
            } else if(card.imageType === 'file' && card.imageData) {
                document.getElementById('previewImg').src = card.imageData;
                document.getElementById('imagePreview').classList.remove('hidden');
            } else if(card.imageType === 'canvas' && card.canvasData) {
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = card.canvasData;
            }

            document.getElementById('cardModal').classList.remove('hidden');
        }

        function deleteCard(cardId) {
            if(!confirm(currentMode === 'child' ? 'ã»ã‚“ã¨ã†ã«ã‘ã™ã®ï¼Ÿ' : 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            cards = cards.filter(c => c.id !== cardId);
            saveData();
            renderCards();
            showToast('ğŸ—‘ï¸ ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function openExportModal() {
            document.getElementById('settingsPanel').classList.add('hidden');
            document.getElementById('exportCategorySelect').innerHTML = categories.map(c => 
                `<option value="${c.id}">${c.emoji} ${currentMode === 'child' ? c.nameChild : c.name}</option>`
            ).join('');
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportCards(type) {
            let exportCards = [];
            if(type === 'all') {
                exportCards = cards;
            } else if(type === 'pinned') {
                exportCards = cards.filter(c => c.pinned);
            } else if(type === 'category') {
                const catId = document.getElementById('exportCategorySelect').value;
                exportCards = cards.filter(c => c.category === catId);
            }

            if(exportCards.length === 0) {
                alert(currentMode === 'child' ? 'ã‹ãƒ¼ã©ãŒãªã„ã‚ˆ' : 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const data = {
                cards: exportCards,
                categories: categories,
                exportDate: new Date().toISOString(),
                exportType: type
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pecs-cards-${type}-${Date.now()}.json`;
            a.click();
            
            // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            setTimeout(() => {
                URL.revokeObjectURL(url);
                closeExportModal();
                showToast(`ğŸ“¦ ${exportCards.length}${currentMode === 'child' ? 'ã¾ã„' : 'æš'}ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
            }, 100);
        }

        function importData() {
            document.getElementById('settingsPanel').classList.add('hidden');
            document.getElementById('importFileInput').click();
        }

        function handleImport(input) {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!data.cards || !Array.isArray(data.cards)) {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼');
                    }
                    
                    const msg = `${data.cards.length}${currentMode === 'child' ? 'ã¾ã„' : 'æš'}ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ï¼ˆé‡è¤‡ã‚«ãƒ¼ãƒ‰ã¯è¿½åŠ ã•ã‚Œã¾ã™ï¼‰`;
                    if(!confirm(msg)) return;

                    if(data.categories && Array.isArray(data.categories)) {
                        data.categories.forEach(newCat => {
                            if(!categories.find(c => c.id === newCat.id)) {
                                categories.push(newCat);
                            }
                        });
                    }

                    data.cards.forEach(card => {
                        cards.push({
                            ...card,
                            id: 'imp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            timestamp: Date.now()
                        });
                    });

                    saveData();
                    refreshUI();
                    showToast(`âœ… ${data.cards.length}${currentMode === 'child' ? 'ã¾ã„' : 'æš'}ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                } catch(err) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ\n' + err.message);
                }
            };
            reader.readAsText(input.files[0]);
            input.value = '';
        }

        function resetData() {
            if(confirm(currentMode === 'child' ? 'ãœã‚“ã¶ã‘ã™ã‚ˆï¼Ÿ' : 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“')) {
                if(confirm(currentMode === 'child' ? 'ã»ã‚“ã¨ã†ã«ã„ã„ã®ï¼Ÿ' : 'æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem(DB_KEY);
                    location.reload();
                }
            }
        }

        function refreshUI() {
            renderCategoryBar();
            renderCards();
            updateModeUI();
        }

        // éŸ³å£°å†ç”Ÿï¼ˆPCç‰ˆChromeå¯¾å¿œå¼·åŒ–ï¼‰
        function initSpeech() {
            if('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
                
                if(window.speechSynthesis.getVoices().length > 0) {
                    const wake = new SpeechSynthesisUtterance('');
                    wake.volume = 0;
                    window.speechSynthesis.speak(wake);
                }
            }
        }

        function playSentence() {
            if(sentenceStrip.length === 0 || isSpeaking) return;

            isSpeaking = true;
            const btn = document.getElementById('playBtn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span class="text-lg font-bold">${currentMode === 'child' ? 'ã˜ã‚…ã‚“ã³ã¡ã‚…ã†...' : 'æº–å‚™ä¸­...'}</span>`;
            btn.classList.add('bg-gray-400');
            btn.classList.remove('bg-blue-600');

            window.speechSynthesis.cancel();
            
            const wake = new SpeechSynthesisUtterance('ã‚');
            wake.volume = 0;
            wake.rate = 10;
            window.speechSynthesis.speak(wake);

            setTimeout(() => {
                speakQueue(0);
            }, 500);
        }

        function speakQueue(idx) {
            if(idx >= sentenceStrip.length) {
                stopSpeaking();
                return;
            }

            const card = sentenceStrip[idx];
            const stripCard = document.getElementById(`strip-${idx}`);
            if(stripCard) stripCard.classList.add('playing-highlight');

            const voices = window.speechSynthesis.getVoices();
            const jpVoice = voices.find(v => v.lang === 'ja-JP') || voices[0];

            const utterance = new SpeechSynthesisUtterance(card.talk);
            utterance.voice = jpVoice;
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            utterance.pitch = 1.1;

            utterance.onend = () => {
                if(stripCard) stripCard.classList.remove('playing-highlight');
                setTimeout(() => speakQueue(idx + 1), 300);
            };

            utterance.onerror = () => {
                if(stripCard) stripCard.classList.remove('playing-highlight');
                stopSpeaking();
            };

            window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            isSpeaking = false;
            window.speechSynthesis.cancel();
            document.querySelectorAll('.playing-highlight').forEach(el => 
                el.classList.remove('playing-highlight')
            );
            const btn = document.getElementById('playBtn');
            btn.innerHTML = `<i class="fas fa-volume-up text-2xl"></i> <span id="playBtnText" class="text-lg font-bold">ãŠã¯ãªã—</span>`;
            btn.classList.remove('bg-gray-400');
            btn.classList.add('bg-blue-600');
        }

        function showToast(msg) {
            const area = document.getElementById('toastArea');
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = msg;
            area.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        window.addEventListener('load', () => {
            init();
            initSpeech();
        });
    </script>
</body>
</html>
